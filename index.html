<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Barber Note Pro V6.5</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@200;300;400;500;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #2b459a;
            --bg: #f8fafc;
            --card: #ffffff;
            --text: #334155;
            --sub: #94a3b8;
            --border: #e2e8f0;
            --green: #22c55e;
            --red: #ef4444;
            --orange: #f59e0b;
        }

        * { box-sizing: border-box; font-family: 'Kanit', sans-serif; -webkit-tap-highlight-color: transparent; }
        body { background-color: var(--bg); color: var(--text); margin: 0; padding-bottom: 100px; }

        .page { display: none; padding: 15px; max-width: 500px; margin: auto; }
        .page.active { display: block; }

        /* Header & Settings Button at Top Right */
        .header { 
            background: var(--card); padding: 15px 20px; text-align: center; 
            border-bottom: 1px solid var(--border); margin-bottom: 15px; 
            border-radius: 0 0 20px 20px; position: relative;
        }
        .header .branch { font-weight: 700; color: var(--primary); font-size: 1.3rem; }
        .btn-set-toggle { 
            position: absolute; right: 20px; top: 50%; transform: translateY(-50%);
            color: var(--sub); font-size: 1.2rem; cursor: pointer; padding: 5px;
        }

        #settings-box { 
            display: none; background: #f0f4ff; border-radius: 16px; padding: 15px; 
            margin-bottom: 15px; border: 1px solid var(--primary); 
        }

        .card { background: var(--card); border-radius: 16px; padding: 15px; margin-bottom: 12px; border: 1px solid var(--border); box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); }
        .label { font-size: 0.75rem; color: var(--sub); font-weight: 600; margin-bottom: 6px; display: block; }

        input, select { 
            width: 100%; border: 1px solid var(--border); border-radius: 10px; padding: 12px; 
            font-size: 1rem; outline: none; background: #fdfdfd; color: var(--text);
        }

        /* Service Item with Delete Button */
        .svc-item { display: grid; grid-template-columns: 1fr 1fr 70px 35px; gap: 6px; margin-bottom: 10px; align-items: center; }
        .btn-del { color: var(--red); font-size: 1.2rem; text-align: center; cursor: pointer; display: flex; align-items: center; justify-content: center; height: 100%; }

        .btn-add-group { margin-top: 10px; display: flex; gap: 15px; }
        .btn-add { color: var(--primary); font-size: 0.85rem; font-weight: 600; cursor: pointer; }
        .btn-expense { color: var(--orange); font-size: 0.85rem; font-weight: 600; cursor: pointer; }

        .pay-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin: 15px 0; }
        .pay-btn { padding: 14px; border-radius: 12px; border: 1px solid var(--border); background: var(--card); text-align: center; cursor: pointer; font-weight: 500; }
        .pay-btn.active { background: var(--primary); color: white; border-color: var(--primary); }

        .btn-main { width: 100%; background: var(--primary); color: white; border: none; padding: 18px; border-radius: 14px; font-size: 1.1rem; font-weight: 600; cursor: pointer; }
        .btn-main.success { background: var(--green) !important; }

        /* Report Styles */
        .stat-group { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px; }
        .box { padding: 15px; border-radius: 16px; border: 1px solid var(--border); background: white; }
        .status-bar { padding: 16px; border-radius: 14px; text-align: center; font-weight: 700; margin-bottom: 15px; }
        .status-bar.orange { background: #ffedd5; color: #9a3412; }
        .status-bar.blue { background: #dbeafe; color: #1e40af; }

        .nav { position: fixed; bottom: 0; width: 100%; background: var(--card); display: flex; border-top: 1px solid var(--border); height: 80px; }
        .nav-item { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; color: var(--sub); cursor: pointer; font-size: 0.75rem; }
        .nav-item.active { color: var(--primary); }
    </style>
</head>
<body>

    <div id="page-rec" class="page active">
        <header class="header">
            <div class="branch" id="head-shop-rec">BARBER SHOP</div>
            <div class="btn-set-toggle" onclick="toggleSettings()"><i class="fas fa-cog"></i></div>
        </header>

        <div id="settings-box">
            <label class="label">ชื่อร้าน</label>
            <input type="text" id="s-name" onchange="updateConfig()" style="margin-bottom:10px;">
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                <div><label class="label">แบ่งช่าง (%)</label><input type="number" id="s-percent" onchange="updateConfig()"></div>
                <div><label class="label">ค่าประกัน (฿)</label><input type="number" id="s-guarantee" onchange="updateConfig()"></div>
            </div>
        </div>

        <div class="card">
            <label class="label">รายการบริการ</label>
            <div id="svc-list"></div>
            <div class="btn-add-group">
                <div class="btn-add" onclick="addRow('service')"><i class="fas fa-plus-circle"></i> เพิ่มบริการเสริม</div>
                <div class="btn-expense" onclick="addRow('expense')"><i class="fas fa-minus-circle"></i> รายจ่าย/เบิก</div>
            </div>
        </div>

        <div class="pay-grid">
            <div class="pay-btn active" id="p-cash" onclick="setPay('เงินสด')">เงินสด</div>
            <div class="pay-btn" id="p-trans" onclick="setPay('โอนเงิน')">โอนเงิน</div>
        </div>

        <button class="btn-main" id="btn-save" onclick="saveRecord()">SAVE RECORD</button>
    </div>

    <div id="page-rep" class="page">
        <div id="head-shop-rep" style="text-align:center; font-weight:700; color:var(--primary); font-size:1.5rem;">BARBER SHOP</div>
        <div id="rep-date-th" style="text-align:center; color:var(--sub); margin-bottom:15px;"></div>
        
        <div class="status-bar" id="status-bar">...</div>

        <div class="stat-group">
            <div class="box">
                <div class="label">เงินสดในมือ</div>
                <b id="r-net-cash">0</b>
            </div>
            <div class="box">
                <div class="label">ค่าแรงช่าง</div>
                <b id="r-barber">0</b>
            </div>
        </div>

        <div id="hist-container"></div>
    </div>

    <nav class="nav">
        <div class="nav-item active" onclick="showPage('rec')"><i class="fas fa-cut"></i><span>บันทึก</span></div>
        <div class="nav-item" onclick="showPage('rep')"><i class="fas fa-coins"></i><span>สรุปยอด</span></div>
    </nav>

    <script>
        const svcs = ["None", "ตัดผม", "โกนหนวด", "กันหน้า", "สระผม", "ย้อมผม", "อื่นๆ"];
        const styles = ["None", "รองทรง", "แฟชั่น", "สกินเฟด", "วินเทจ"];
        
        let db = JSON.parse(localStorage.getItem('barber_v6_db') || '[]');
        let cfg = JSON.parse(localStorage.getItem('barber_v6_cfg') || '{"name":"BARBER SHOP","percent":50,"guarantee":300}');
        let payType = 'เงินสด';

        window.onload = () => {
            document.getElementById('rec-date-raw').value = new Date().toISOString().split('T')[0];
            applyConfig();
            addRow('service'); // Start with one row
        };

        function toggleSettings() {
            const box = document.getElementById('settings-box');
            box.style.display = (box.style.display === 'block') ? 'none' : 'block';
        }

        function applyConfig() {
            document.getElementById('head-shop-rec').innerText = cfg.name;
            document.getElementById('s-name').value = cfg.name;
            document.getElementById('s-percent').value = cfg.percent;
            document.getElementById('s-guarantee').value = cfg.guarantee;
        }

        function updateConfig() {
            cfg.name = document.getElementById('s-name').value || "BARBER SHOP";
            cfg.percent = parseInt(document.getElementById('s-percent').value) || 0;
            cfg.guarantee = parseInt(document.getElementById('s-guarantee').value) || 0;
            localStorage.setItem('barber_v6_cfg', JSON.stringify(cfg));
            applyConfig();
        }

        // --- เพิ่ม/ลบ แถวรายการ ---
        function addRow(type) {
            const container = document.getElementById('svc-list');
            const rowId = 'row-' + Date.now();
            const div = document.createElement('div');
            div.className = 'svc-item';
            div.id = rowId;
            div.dataset.type = type;

            if(type === 'service') {
                div.innerHTML = `
                    <select class="i-svc">${svcs.map(s => `<option value="${s}">${s}</option>`).join('')}</select>
                    <select class="i-style">${styles.map(s => `<option value="${s}">${s}</option>`).join('')}</select>
                    <input type="number" class="i-price" placeholder="ราคา" value="150">
                    <div class="btn-del" onclick="removeRow('${rowId}')"><i class="fas fa-times-circle"></i></div>
                `;
            } else {
                div.innerHTML = `
                    <input type="text" class="i-svc" placeholder="ระบุรายจ่าย/เบิก" style="grid-column: span 2; border-color: var(--orange);">
                    <input type="number" class="i-price" placeholder="฿" style="border-color: var(--orange);">
                    <div class="btn-del" onclick="removeRow('${rowId}')"><i class="fas fa-times-circle" style="color:var(--orange)"></i></div>
                `;
            }
            container.appendChild(div);
        }

        function removeRow(id) {
            const row = document.getElementById(id);
            // อนุญาตให้ลบได้ถ้ามีมากกว่า 1 แถว หรือลบแถวที่เป็นรายจ่าย
            if (document.querySelectorAll('.svc-item').length > 1) {
                row.remove();
            } else {
                alert("ต้องมีอย่างน้อย 1 รายการครับ");
            }
        }

        function setPay(t) {
            payType = t;
            document.getElementById('p-cash').classList.toggle('active', t === 'เงินสด');
            document.getElementById('p-trans').classList.toggle('active', t === 'โอนเงิน');
        }

        function saveRecord() {
            const rows = document.querySelectorAll('.svc-item');
            let items = [], total = 0, exp = 0;
            rows.forEach(r => {
                const p = parseInt(r.querySelector('.i-price').value) || 0;
                if(r.dataset.type === 'service' && p > 0) {
                    items.push({ name: r.querySelector('.i-svc').value, price: p, type: 'svc' });
                    total += p;
                } else if(r.dataset.type === 'expense' && p > 0) {
                    items.push({ name: r.querySelector('.i-svc').value || 'เบิก/จ่าย', price: p, type: 'exp' });
                    exp += p;
                }
            });

            if(total === 0 && exp === 0) return alert('กรุณาใส่ราคา');

            db.push({ 
                id: Date.now(), 
                date: document.getElementById('rec-date-raw').value, 
                total: total, 
                expense: exp, 
                pay: payType,
                items: items
            });

            localStorage.setItem('barber_v6_db', JSON.stringify(db));
            alert('บันทึกเรียบร้อย');
            document.getElementById('svc-list').innerHTML = '';
            addRow('service');
        }

        function showPage(p) {
            document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
            document.getElementById('page-' + p).classList.add('active');
            if(p === 'rep') renderReport();
        }

        function renderReport() {
            const date = document.getElementById('rec-date-raw').value;
            const data = db.filter(r => r.date === date);
            let sTotal = 0, sCash = 0, sExp = 0;

            data.forEach(r => {
                sTotal += r.total;
                sExp += r.expense;
                if(r.pay === 'เงินสด') sCash += r.total;
            });

            let barber = (sTotal * cfg.percent / 100);
            if(sTotal > 0 && barber < cfg.guarantee) barber = cfg.guarantee;
            
            let netInHand = sCash - sExp;
            let finalClear = netInHand - barber;

            document.getElementById('r-barber').innerText = barber.toLocaleString();
            document.getElementById('r-net-cash').innerText = netInHand.toLocaleString();
            
            const bar = document.getElementById('status-bar');
            if(finalClear >= 0) {
                bar.innerText = `ช่างคืนเงินร้าน: ฿${finalClear.toLocaleString()}`;
                bar.className = 'status-bar orange';
            } else {
                bar.innerText = `ร้านคืนเงินช่าง: ฿${Math.abs(finalClear).toLocaleString()}`;
                bar.className = 'status-bar blue';
            }
        }
    </script>
</body>
</html>
