<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link rel="apple-touch-icon" href="https://i.ibb.co/27GqTXFn/Barber-Note.png">
    <link rel="icon" type="image/png" href="https://i.ibb.co/27GqTXFn/Barber-Note.png">
    <title>Barber Note Ultimate V.8.9</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #4e7d4e; --bg: #f8fafc; --card: #ffffff; --text: #334155; --sub: #94a3b8; --border: #e2e8f0; --accent: #2b459a; }
        * { box-sizing: border-box; font-family: 'Kanit', sans-serif; -webkit-tap-highlight-color: transparent; }
        body { background-color: var(--bg); color: var(--text); margin: 0; padding-bottom: 100px; }
        .page { display: none; padding: 15px; max-width: 500px; margin: auto; }
        .page.active { display: block; }
        
        .header { text-align: center; padding: 10px 0; border-bottom: 1px dashed var(--border); margin-bottom: 15px; }
        .shop-name { font-size: 1.6rem; font-weight: 700; color: var(--primary); text-transform: uppercase; }

        /* Dashboard กล่องคู่ ตามรูปภาพ */
        .db-container { display: grid; grid-template-columns: 1.2fr 0.8fr; gap: 10px; margin-bottom: 12px; }
        .db-main { background: var(--primary); color: white; border-radius: 15px; padding: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .db-side { background: white; border-radius: 15px; padding: 15px; border: 1px solid var(--border); display: flex; flex-direction: column; justify-content: center; }
        
        .side-row { display: flex; justify-content: space-between; font-size: 0.85rem; padding: 5px 0; border-bottom: 1px solid #f1f5f9; }
        .side-row:last-child { border: 0; }
        .side-row b { color: var(--text); }

        /* สถิติบริการ */
        .stat-line { font-size: 0.8rem; margin-top: 10px; opacity: 0.9; }

        /* การ์ดบันทึก */
        .card { background: white; border-radius: 20px; padding: 15px; border: 1px solid var(--border); margin-bottom: 12px; }
        .svc-row { display: grid; grid-template-columns: 1.1fr 1.1fr 70px 25px; gap: 5px; margin-bottom: 10px; align-items: center; }
        select, input { border: 1px solid var(--border); border-radius: 10px; padding: 10px; font-size: 0.9rem; background: #fafafa; width: 100%; outline: none; }
        
        .btn-main { width: 100%; background: var(--primary); color: white; border: none; padding: 16px; border-radius: 15px; font-weight: 600; font-size: 1.1rem; cursor: pointer; }
        .settle-bar { background: #eef2ff; color: var(--accent); text-align: center; padding: 12px; border-radius: 15px; font-weight: 600; margin-bottom: 15px; font-size: 1.1rem; }
        .gua-tag { background: #dbeafe; color: var(--accent); text-align: center; padding: 8px; border-radius: 10px; font-size: 0.9rem; margin-bottom: 15px; font-weight: 500; }

        /* Theme Selection */
        .theme-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-top: 10px; }
        .theme-dot { height: 35px; border-radius: 8px; cursor: pointer; border: 2px solid transparent; }
        .theme-dot.active { border-color: #333; }

        .nav { position: fixed; bottom: 0; width: 100%; background: white; display: flex; border-top: 1px solid var(--border); height: 75px; box-shadow: 0 -2px 10px rgba(0,0,0,0.05); }
        .nav-item { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; color: var(--sub); font-size: 0.75rem; }
        .nav-item.active { color: var(--primary); font-weight: 600; }
        .nav-item i { font-size: 1.3rem; margin-bottom: 4px; }
    </style>
</head>
<body>

    <div id="page-rec" class="page active">
        <div class="header">
            <div class="shop-name" id="sh-n1">BARBER SHOP</div>
            <div id="cur-date" style="font-size:0.85rem; color:var(--sub); margin-top:5px;"></div>
        </div>
        <div class="card">
            <div id="svc-list"></div>
            <div onclick="addSvcRow()" style="color:var(--primary); font-weight:600; cursor:pointer; margin-top:10px; font-size:0.9rem;"><i class="fas fa-plus-circle"></i> เพิ่มบริการ</div>
        </div>
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-bottom:20px;">
            <button id="p-cash" onclick="setPay('เงินสด')" style="padding:15px; border-radius:12px; border:1px solid var(--border); background:white; font-weight:600;">เงินสด</button>
            <button id="p-trans" onclick="setPay('โอนเงิน')" style="padding:15px; border-radius:12px; border:1px solid var(--border); background:white; font-weight:600;">โอนเงิน</button>
        </div>
        <button class="btn-main" onclick="saveRecord()">บันทึกข้อมูลวันนี้</button>
    </div>

    <div id="page-rep" class="page">
        <div class="header"><div class="shop-name" id="sh-n2">...</div></div>
        
        <div class="db-container">
            <div class="db-main">
                <small style="opacity:0.8;">ยอดเงินรวม</small>
                <div style="font-size:2.2rem; font-weight:700; margin:5px 0;">฿<span id="r-total">0</span></div>
                <div class="stat-line">ลูกค้า <span id="r-count">0</span> คน | โกน <span id="s-1">0</span> | สระ <span id="s-2">0</span> | ย้อม <span id="s-3">0</span></div>
            </div>
            <div class="db-side">
                <div class="side-row"><span>โอนรวม</span><b id="r-trans">0</b></div>
                <div class="side-row"><span>รายได้ช่าง</span><b id="r-barber" style="color:var(--primary);">0</b></div>
                <div class="side-row"><span>รายได้ร้าน</span><b id="r-shop">0</b></div>
            </div>
        </div>

        <div class="gua-tag" id="gua-display">ประกันรายได้วันนี้ ฿0</div>
        <div class="settle-bar" id="settle-text">...</div>
        
        <div id="hist-list"></div>
        <center><small style="color:#ff7675; cursor:pointer;" onclick="clearToday()">ล้างข้อมูลวันนี้</small></center>
    </div>

    <div id="page-his" class="page">
        <div class="header"><div class="shop-name">ประวัติรายเดือน</div></div>
        <div class="card" style="background:#2d3436; color:white; border:none;">
            <b id="m-label">เดือนนี้</b>
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:15px; margin-top:15px;">
                <div><small style="opacity:0.7;">ยอดขาย</small><br><b id="m-total" style="font-size:1.3rem;">0</b></div>
                <div><small style="opacity:0.7;">ช่างได้</small><br><b id="m-barber" style="color:#55efc4;">0</b></div>
                <div><small style="opacity:0.7;">ร้านได้</small><br><b id="m-shop">0</b></div>
                <div><small style="opacity:0.7;">ลูกค้าสะสม</small><br><b id="m-count">0</b></div>
            </div>
        </div>
        <input type="month" id="hist-month" class="card" onchange="renderHistory()" style="width:100%;">
        <div id="monthly-list"></div>
    </div>

    <div id="page-set" class="page">
        <div class="header"><div class="shop-name">ตั้งค่าระบบ</div></div>
        <div class="card">
            <label>ชื่อร้าน</label><input type="text" id="cfg-name" style="margin-bottom:10px;">
            <label>ส่วนแบ่งช่าง (%)</label><input type="number" id="cfg-per" style="margin-bottom:10px;">
            <label>ประกันรายได้ช่าง (฿)</label><input type="number" id="cfg-gua">
            <button class="btn-main" style="margin-top:15px;" onclick="saveCfg()">บันทึกการตั้งค่า</button>
        </div>
        <div class="card">
            <label>ธีมพาสเทล 7 สี</label>
            <div class="theme-grid" id="theme-selector"></div>
        </div>
    </div>

    <nav class="nav">
        <div class="nav-item active" onclick="showPage('rec')"><i class="fas fa-edit"></i><span>บันทึก</span></div>
        <div class="nav-item" onclick="showPage('rep')"><i class="fas fa-file-invoice-dollar"></i><span>สรุปงาน</span></div>
        <div class="nav-item" onclick="showPage('his')"><i class="fas fa-history"></i><span>ประวัติ</span></div>
        <div class="nav-item" onclick="showPage('set')"><i class="fas fa-cog"></i><span>ตั้งค่า</span></div>
    </nav>

    <script>
        const svcs = ["ตัดผม", "โกนหนวด", "กันหน้า", "แก้ผม", "สระผม", "ย้อมผม", "ดัด", "อื่นๆ"];
        const styles = ["รองทรง", "แฟชั่น / ทูบล็อค", "สกินเฟด", "นักเรียน", "ตำรวจ / ทหาร", "ทรงอเมริกัน", "เปิดข้าง / วินเทจ"];
        const themes = ['#4e7d4e', '#7fb3d5', '#f1948a', '#bb8fce', '#f8c471', '#f7dc6f', '#aab7b8'];

        let db = JSON.parse(localStorage.getItem('barber_v89_db') || '[]');
        let cfg = JSON.parse(localStorage.getItem('barber_v89_cfg') || '{"name":"BARBER SHOP","percent":50,"guarantee":300,"theme":"#4e7d4e"}');
        let payType = 'เงินสด';
        let today = new Date().toISOString().split('T')[0];

        window.onload = () => {
            document.getElementById('cur-date').innerText = new Date().toLocaleDateString('th-TH', {day:'numeric', month:'long', year:'numeric'});
            document.getElementById('hist-month').value = today.substring(0, 7);
            initThemes();
            applyCfg();
            addSvcRow();
            setPay('เงินสด');
        };

        function addSvcRow() {
            const div = document.createElement('div');
            div.className = 'svc-row';
            div.innerHTML = `
                <select class="i-svc">${svcs.map(s=>`<option value="${s}">${s}</option>`).join('')}</select>
                <select class="i-style">${styles.map(s=>`<option value="${s}">${s}</option>`).join('')}</select>
                <input type="number" class="i-price" value="150">
                <div onclick="this.parentElement.remove()" style="color:#ff7675; text-align:center;"><i class="fas fa-times-circle"></i></div>`;
            document.getElementById('svc-list').appendChild(div);
        }

        function setPay(t) {
            payType = t;
            document.getElementById('p-cash').style.backgroundColor = t==='เงินสด'? 'var(--primary)':'white';
            document.getElementById('p-cash').style.color = t==='เงินสด'? 'white':'var(--text)';
            document.getElementById('p-trans').style.backgroundColor = t==='โอนเงิน'? 'var(--primary)':'white';
            document.getElementById('p-trans').style.color = t==='โอนเงิน'? 'white':'var(--text)';
        }

        function saveRecord() {
            let items = []; let total = 0;
            document.querySelectorAll('.svc-row').forEach(row => {
                const p = parseInt(row.querySelector('.i-price').value) || 0;
                items.push({ svc: row.querySelector('.i-svc').value, style: row.querySelector('.i-style').value, price: p });
                total += p;
            });
            if(total === 0) return alert('กรุณาใส่ราคา');
            db.push({ id: Date.now(), date: today, items, total, pay: payType, time: new Date().toLocaleTimeString('th-TH',{hour:'2-digit', minute:'2-digit'}) });
            localStorage.setItem('barber_v89_db', JSON.stringify(db));
            alert('บันทึกเรียบร้อย'); location.reload();
        }

        function renderReport() {
            const daily = db.filter(r => r.date === today);
            let total = 0, trans = 0, s = {"โกนหนวด":0, "สระผม":0, "ย้อมผม":0};
            let html = '';

            daily.forEach(r => {
                total += r.total; if(r.pay === 'โอนเงิน') trans += r.total;
                r.items.forEach(i => { if(s[i.svc] !== undefined) s[i.svc]++; });
                html += `<div class="card" style="padding:12px; margin-bottom:8px; display:flex; justify-content:space-between; align-items:center;">
                    <div><b>${r.items.map(i=>i.svc).join('+')}</b><br><small>${r.time} | ${r.items[0].style}</small></div>
                    <div style="text-align:right;"><b>฿${r.total}</b><br><small>${r.pay}</small></div>
                </div>`;
            });

            const barberShare = Math.max(cfg.guarantee, (total * cfg.percent / 100));
            const shopShare = total - barberShare;

            document.getElementById('r-total').innerText = total.toLocaleString();
            document.getElementById('r-count').innerText = daily.length;
            document.getElementById('r-trans').innerText = trans.toLocaleString();
            document.getElementById('r-barber').innerText = Math.floor(barberShare).toLocaleString();
            document.getElementById('r-shop').innerText = Math.floor(shopShare).toLocaleString();
            document.getElementById('s-1').innerText = s["โกนหนวด"];
            document.getElementById('s-2').innerText = s["สระผม"];
            document.getElementById('s-3').innerText = s["ย้อมผม"];
            document.getElementById('gua-display').innerText = `ประกันรายได้วันนี้ ฿${cfg.guarantee}`;

            const settle = (total - trans) - barberShare;
            document.getElementById('settle-text').innerText = settle >= 0 ? `ช่างคืนร้าน ฿${Math.floor(settle)}` : `ร้านคืนช่าง ฿${Math.floor(Math.abs(settle))}`;
            document.getElementById('hist-list').innerHTML = html || '<center style="padding:40px; color:#ccc;">ไม่มีข้อมูลของวันนี้</center>';
        }

        function renderHistory() {
            const m = document.getElementById('hist-month').value;
            const data = db.filter(r => r.date.startsWith(m));
            let tTotal = 0, tBarber = 0, tShop = 0;
            
            // สรุปรายเดือนแยกวันเพื่อคำนวณประกันมือแม่นยำ
            const days = [...new Set(data.map(r => r.date))];
            days.forEach(d => {
                const dayData = data.filter(r => r.date === d);
                const dayTotal = dayData.reduce((a,b) => a + b.total, 0);
                const dayBarber = Math.max(cfg.guarantee, (dayTotal * cfg.percent / 100));
                tTotal += dayTotal;
                tBarber += dayBarber;
                tShop += (dayTotal - dayBarber);
            });

            document.getElementById('m-total').innerText = '฿'+tTotal.toLocaleString();
            document.getElementById('m-barber').innerText = '฿'+Math.floor(tBarber).toLocaleString();
            document.getElementById('m-shop').innerText = '฿'+Math.floor(tShop).toLocaleString();
            document.getElementById('m-count').innerText = data.length + ' คน';
        }

        function initThemes() {
            const container = document.getElementById('theme-selector');
            themes.forEach(t => {
                const dot = document.createElement('div');
                dot.className = `theme-dot ${cfg.theme === t ? 'active' : ''}`;
                dot.style.backgroundColor = t;
                dot.onclick = () => {
                    cfg.theme = t;
                    localStorage.setItem('barber_v89_cfg', JSON.stringify(cfg));
                    location.reload();
                };
                container.appendChild(dot);
            });
            document.documentElement.style.setProperty('--primary', cfg.theme);
        }

        function applyCfg() {
            document.getElementById('sh-n1').innerText = cfg.name;
            document.getElementById('sh-n2').innerText = cfg.name;
            document.getElementById('cfg-name').value = cfg.name;
            document.getElementById('cfg-per').value = cfg.percent;
            document.getElementById('cfg-gua').value = cfg.guarantee;
        }

        function saveCfg() {
            cfg.name = document.getElementById('cfg-name').value;
            cfg.percent = parseInt(document.getElementById('cfg-per').value);
            cfg.guarantee = parseInt(document.getElementById('cfg-gua').value);
            localStorage.setItem('barber_v89_cfg', JSON.stringify(cfg));
            alert('บันทึกสำเร็จ'); location.reload();
        }

        function clearToday() {
            if(confirm('ยืนยันการล้างข้อมูลของวันนี้ทั้งหมด?')) {
                db = db.filter(r => r.date !== today);
                localStorage.setItem('barber_v89_db', JSON.stringify(db));
                location.reload();
            }
        }

        function showPage(p) {
            document.querySelectorAll('.page').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            document.getElementById('page-' + p).classList.add('active');
            event.currentTarget.classList.add('active');
            if(p === 'rep') renderReport();
            if(p === 'his') renderHistory();
        }
    </script>
</body>
</html>
