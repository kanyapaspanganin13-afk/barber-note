<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Barber Note v2.2</title>
    
    <link rel="apple-touch-icon" href="https://i.ibb.co/27GqTXFn/Barber-Note.png">
    <link rel="icon" type="image/png" href="https://i.ibb.co/27GqTXFn/Barber-Note.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-title" content="Barber Note">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600&display=swap');
        *{font-family:'Kanit',sans-serif;-webkit-tap-highlight-color:transparent}
        
        /* Theme Logic */
        :root { --primary: #1e293b; --primary-content: #ffffff; --bg-pastel: #f8fafc; }
        .theme-dark { --primary: #0f172a; --primary-content: #f8fafc; }
        .theme-blue { --primary: #1e40af; --primary-content: #ffffff; }
        .theme-green { --primary: #065f46; --primary-content: #ffffff; }

        body { background-color: var(--bg-pastel); color: #1e293b; padding-bottom: 90px; transition: all 0.3s ease; }
        .header-bg { background-color: var(--primary); color: var(--primary-content); }
        
        .card { background: white; border-radius: 16px; border: 1px solid #e2e8f0; padding: 12px 16px; margin-bottom: 10px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); }
        input, select { width: 100%; font-size: 18px!important; font-weight: 600; outline: none; background: transparent; }
        
        .pay-btn { border-radius: 12px; padding: 14px; text-align: center; border: 2px solid #e2e8f0; background: white; cursor: pointer; transition: 0.2s; font-weight: 600; }
        .pay-btn.active { background-color: var(--primary); color: var(--primary-content); border-color: var(--primary); }
        
        .btn-main { background-color: var(--primary); color: var(--primary-content); width: 100%; padding: 18px; border-radius: 16px; font-size: 20px; font-weight: 700; transition: transform 0.1s; }
        .btn-main:active { transform: scale(0.96); opacity: 0.9; }

        .nav-bar { position: fixed; bottom: 0; left: 0; right: 0; height: 80px; background: white; border-top: 1px solid #e2e8f0; display: flex; z-index: 50; padding-bottom: env(safe-area-inset-bottom); }
        .nav-item { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; color: #94a3b8; font-size: 12px; }
        .nav-item.active { color: var(--primary); font-weight: 700; }

        .hidden { display: none !important; }
    </style>
</head>
<body>

    <header class="header-bg p-5 flex justify-between items-center sticky top-0 z-40 shadow-md">
        <div id="header-shop-name" class="text-xl font-bold uppercase tracking-tight">Barber Note</div>
        <button onclick="toggleSettings()" class="opacity-70 hover:opacity-100"><i class="fa-solid fa-gear text-lg"></i></button>
    </header>

    <main class="p-4 max-w-md mx-auto">
        
        <div id="page-rec" class="space-y-3">
            <div class="card"><label class="text-[10px] text-gray-400 uppercase font-bold">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label><input type="date" id="rec-date"></div>
            <div class="flex gap-2">
                <div class="card flex-1"><label class="text-[10px] text-gray-400 uppercase font-bold">‡πÄ‡∏£‡∏¥‡πà‡∏°</label><input type="time" id="rec-start"></div>
                <div class="card flex-1"><label class="text-[10px] text-gray-400 uppercase font-bold">‡πÄ‡∏™‡∏£‡πá‡∏à</label><input type="time" id="rec-end"></div>
            </div>

            <div id="svc-container" class="space-y-2">
                </div>
            <button onclick="addSvcRow()" class="w-full py-3 rounded-xl border-2 border-dashed border-gray-300 text-gray-400 font-bold text-sm">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£</button>

            <div class="card">
                <label class="text-[10px] text-gray-400 uppercase font-bold">‡∏ó‡∏£‡∏á‡∏ú‡∏°</label>
                <select id="rec-style">
                    <option>‡∏£‡∏≠‡∏á‡∏ó‡∏£‡∏á</option><option>‡πÄ‡∏õ‡∏¥‡∏î‡∏Ç‡πâ‡∏≤‡∏á / ‡∏ß‡∏¥‡∏ô‡πÄ‡∏ó‡∏à</option><option>‡πÅ‡∏ü‡∏ä‡∏±‡πà‡∏ô / ‡∏ó‡∏π‡∏ö‡∏•‡πá‡∏≠‡∏Ñ</option>
                    <option>‡∏™‡∏Å‡∏¥‡∏ô‡πÄ‡∏ü‡∏î</option><option>‡∏ó‡∏£‡∏á‡∏≠‡πÄ‡∏°‡∏£‡∏¥‡∏Å‡∏±‡∏ô</option><option>‡∏ï‡∏≥‡∏£‡∏ß‡∏à / ‡∏ó‡∏´‡∏≤‡∏£</option><option>‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</option>
                </select>
            </div>

            <div class="grid grid-cols-2 gap-3 py-2">
                <div onclick="setPay('cash')" id="pay-cash" class="pay-btn active">‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î</div>
                <div onclick="setPay('transfer')" id="pay-transfer" class="pay-btn">‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</div>
            </div>
            <button onclick="saveRecord()" class="btn-main mt-4 shadow-lg">SAVE RECORD</button>
        </div>

        <div id="page-rep" class="hidden space-y-4">
            <div class="text-center">
                <div id="rep-shop-display" class="font-bold text-gray-400 uppercase text-xs">SHOP NAME</div>
                <div id="rep-date-display" class="text-xl font-bold">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà 1 ‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏° 2567</div>
            </div>

            <div class="grid grid-cols-1 gap-3">
                <div class="card bg-white border-2 border-gray-100 flex flex-col items-center justify-center py-6">
                    <span class="text-gray-400 text-xs font-bold uppercase">‡∏¢‡∏≠‡∏î‡∏ï‡∏±‡∏î‡∏£‡∏ß‡∏°</span>
                    <span class="text-5xl font-bold text-slate-800">‡∏ø<span id="rep-total">0</span></span>
                </div>
                <div class="grid grid-cols-3 gap-2">
                    <div class="card flex flex-col items-center p-2">
                        <span class="text-[10px] text-gray-400 font-bold">‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</span>
                        <span id="rep-cust" class="text-lg font-bold">0</span>
                    </div>
                    <div class="card flex flex-col items-center p-2">
                        <span class="text-[10px] text-gray-400 font-bold">‡∏ä‡πà‡∏≤‡∏á</span>
                        <span id="rep-barber" class="text-lg font-bold text-blue-600">0</span>
                    </div>
                    <div class="card flex flex-col items-center p-2">
                        <span class="text-[10px] text-gray-400 font-bold">‡∏£‡πâ‡∏≤‡∏ô</span>
                        <span id="rep-shop" class="text-lg font-bold text-emerald-600">0</span>
                    </div>
                </div>
                <div class="card flex justify-between items-center py-3 bg-blue-50 border-blue-100">
                    <span class="text-blue-500 font-bold text-sm">‡∏¢‡∏≠‡∏î‡πÇ‡∏≠‡∏ô (‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏£‡πâ‡∏≤‡∏ô)</span>
                    <span class="text-blue-700 font-bold text-lg">‡∏ø<span id="rep-transfer">0</span></span>
                </div>
            </div>

            <div class="space-y-2" id="rep-list">
                </div>

            <button onclick="clearToday()" class="w-full py-4 text-red-500 font-bold text-sm border-2 border-red-100 rounded-2xl bg-red-50 mt-10">‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
        </div>

        <div id="page-his" class="hidden space-y-4">
            <div class="card">
                <label class="text-[10px] text-gray-400 uppercase font-bold">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏î‡∏π‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô</label>
                <input type="date" id="his-date-select" onchange="renderHistory()">
            </div>

            <div id="his-daily-card">
                </div>

            <hr class="border-gray-200">
            <div class="font-bold text-lg px-1">üìä ‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</div>
            <div id="his-month-stats" class="grid grid-cols-1 gap-2">
                </div>
        </div>

        <div id="modal-set" class="hidden fixed inset-0 z-50 flex items-center justify-center p-6 bg-black/60 backdrop-blur-sm">
            <div class="bg-white w-full max-w-sm rounded-3xl p-6 space-y-4">
                <div class="flex justify-between items-center border-b pb-3">
                    <span class="text-lg font-bold">‚öôÔ∏è ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏£‡∏∞‡∏ö‡∏ö</span>
                    <button onclick="toggleSettings()" class="text-gray-400 text-xl">&times;</button>
                </div>
                
                <div class="space-y-3">
                    <div class="card !m-0"><label class="text-[10px] text-gray-400 uppercase font-bold">‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô / ‡∏™‡∏≤‡∏Ç‡∏≤</label><input type="text" id="set-shop"></div>
                    <div class="grid grid-cols-2 gap-2">
                        <div class="card !m-0"><label class="text-[10px] text-gray-400 uppercase font-bold">‡∏Ñ‡∏≠‡∏°‡∏°‡∏¥‡∏ä‡∏ä‡∏±‡πà‡∏ô (%)</label><input type="number" id="set-percent"></div>
                        <div class="card !m-0"><label class="text-[10px] text-gray-400 uppercase font-bold">‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ (‡∏ø)</label><input type="number" id="set-guarantee"></div>
                    </div>
                    
                    <div>
                        <label class="text-[10px] text-gray-400 uppercase font-bold mb-2 block">‡∏ò‡∏µ‡∏°‡∏´‡∏•‡∏±‡∏Å</label>
                        <div class="grid grid-cols-3 gap-2">
                            <button onclick="updateTheme('theme-blue')" class="p-2 rounded-lg bg-blue-800 text-white text-[10px]">BLUE</button>
                            <button onclick="updateTheme('theme-dark')" class="p-2 rounded-lg bg-slate-900 text-white text-[10px]">DARK</button>
                            <button onclick="updateTheme('theme-green')" class="p-2 rounded-lg bg-emerald-900 text-white text-[10px]">GREEN</button>
                        </div>
                    </div>

                    <div>
                        <label class="text-[10px] text-gray-400 uppercase font-bold mb-2 block">‡∏™‡∏µ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏û‡∏≤‡∏™‡πÄ‡∏ó‡∏•</label>
                        <div class="flex flex-wrap gap-2">
                            <div onclick="updateBg('#f8fafc')" class="w-8 h-8 rounded-full border bg-[#f8fafc]"></div>
                            <div onclick="updateBg('#fff7ed')" class="w-8 h-8 rounded-full border bg-[#fff7ed]"></div>
                            <div onclick="updateBg('#f0fdf4')" class="w-8 h-8 rounded-full border bg-[#f0fdf4]"></div>
                            <div onclick="updateBg('#f5f3ff')" class="w-8 h-8 rounded-full border bg-[#f5f3ff]"></div>
                            <div onclick="updateBg('#fff1f2')" class="w-8 h-8 rounded-full border bg-[#fff1f2]"></div>
                            <div onclick="updateBg('#f0fbff')" class="w-8 h-8 rounded-full border bg-[#f0fbff]"></div>
                            <div onclick="updateBg('#ffffff')" class="w-8 h-8 rounded-full border bg-[#ffffff]"></div>
                        </div>
                    </div>
                </div>
                <button onclick="saveSettings()" class="btn-main">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</button>
            </div>
        </div>
    </main>

    <nav class="nav-bar">
        <div onclick="nav('rec')" id="n-rec" class="nav-item active"><i class="fa-solid fa-plus-square text-2xl mb-1"></i>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</div>
        <div onclick="nav('rep')" id="n-rep" class="nav-item"><i class="fa-solid fa-clipboard-list text-2xl mb-1"></i>‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</div>
        <div onclick="nav('his')" id="n-his" class="nav-item"><i class="fa-solid fa-clock-rotate-left text-2xl mb-1"></i>‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</div>
    </nav>

    <script>
        let db = JSON.parse(localStorage.getItem('barber_note_db_v2')) || [];
        let config = JSON.parse(localStorage.getItem('barber_note_cfg')) || {
            shop: "LA-MOON CUT", percent: 50, guarantee: 200, theme: 'theme-blue', bg: '#f8fafc'
        };
        let currentPay = 'cash';

        const $ = (id) => document.getElementById(id);

        function init() {
            const now = new Date();
            $('rec-date').valueAsDate = now;
            $('rec-start').value = now.toTimeString().slice(0, 5);
            $('rec-end').value = new Date(now.getTime() + 30 * 60000).toTimeString().slice(0, 5);
            $('his-date-select').valueAsDate = now;
            
            // Set Config UI
            $('set-shop').value = config.shop;
            $('set-percent').value = config.percent;
            $('set-guarantee').value = config.guarantee;
            applyConfig();
            
            if(document.querySelectorAll('.svc-row').length === 0) addSvcRow();
        }

        function applyConfig() {
            $('header-shop-name').innerText = config.shop;
            $('rep-shop-display').innerText = config.shop;
            document.documentElement.className = config.theme;
            document.body.style.setProperty('--bg-pastel', config.bg);
            document.body.style.backgroundColor = config.bg;
        }

        function addSvcRow() {
            const container = $('svc-container');
            const div = document.createElement('div');
            div.className = "card flex svc-row relative items-end gap-2";
            div.innerHTML = `
                <div class="flex-1">
                    <label class="text-[9px] text-gray-400 uppercase font-bold">‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£</label>
                    <select class="svc-name">
                        <option>‡∏ï‡∏±‡∏î‡∏ú‡∏°</option><option>‡∏¢‡πâ‡∏≠‡∏°‡∏ú‡∏°</option><option>‡∏™‡∏£‡∏∞‡∏ú‡∏°</option>
                        <option>‡πÅ‡∏Å‡πâ‡∏ú‡∏°</option><option>‡∏Å‡∏±‡∏ô‡∏´‡∏ô‡πâ‡∏≤</option><option>‡πÇ‡∏Å‡∏ô‡∏´‡∏ô‡∏ß‡∏î</option>
                        <option>‡∏î‡∏±‡∏î‡∏ú‡∏°</option><option>‡∏≠‡∏∑‡πà‡∏ô‡πÜ</option>
                    </select>
                </div>
                <div class="w-24">
                    <label class="text-[9px] text-gray-400 uppercase font-bold">‡∏£‡∏≤‡∏Ñ‡∏≤ (‡∏ø)</label>
                    <input type="number" class="svc-price text-right font-bold text-blue-600" placeholder="0">
                </div>
                <button onclick="this.parentElement.remove()" class="text-red-300 pb-1"><i class="fa-solid fa-circle-minus"></i></button>
            `;
            container.appendChild(div);
        }

        function setPay(type) {
            currentPay = type;
            $('pay-cash').classList.toggle('active', type === 'cash');
            $('pay-transfer').classList.toggle('active', type === 'transfer');
        }

        function saveRecord() {
            let total = 0;
            let services = [];
            let nonBarberCount = 0;

            document.querySelectorAll('.svc-row').forEach(row => {
                const name = row.querySelector('.svc-name').value;
                const price = Number(row.querySelector('.svc-price').value);
                if(price > 0) {
                    total += price;
                    services.push(name);
                    if(name !== "‡∏ï‡∏±‡∏î‡∏ú‡∏°") nonBarberCount++;
                }
            });

            if(total <= 0) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£");

            const record = {
                id: Date.now(),
                date: $('rec-date').value,
                start: $('rec-start').value,
                end: $('rec-end').value,
                style: $('rec-style').value,
                payType: currentPay,
                total: total,
                services: services,
                custCount: 1 + nonBarberCount // ‡∏™‡∏π‡∏ï‡∏£‡∏û‡∏¥‡πÄ‡∏®‡∏©
            };

            db.push(record);
            localStorage.setItem('barber_note_db_v2', JSON.stringify(db));
            
            // Alert & Refresh
            if(window.navigator.vibrate) window.navigator.vibrate(50);
            alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
            location.reload();
        }

        function nav(page) {
            ['rec', 'rep', 'his'].forEach(p => {
                $(`page-${p}`).classList.add('hidden');
                $(`n-${p}`).classList.remove('active');
            });
            $(`page-${page}`).classList.remove('hidden');
            $(`n-${page}`).classList.add('active');
            
            if(page === 'rep') renderReport();
            if(page === 'his') renderHistory();
        }

        function calculateStats(records) {
            const sumTotal = records.reduce((s, r) => s + r.total, 0);
            const sumTransfer = records.reduce((s, r) => r.payType === 'transfer' ? s + r.total : s, 0);
            const sumCust = records.reduce((s, r) => s + r.custCount, 0);
            const barberEarn = Math.max(sumTotal * config.percent / 100, records.length > 0 ? config.guarantee : 0);
            const shopEarn = sumTotal - barberEarn;
            
            return { sumTotal, sumTransfer, sumCust, barberEarn, shopEarn };
        }

        function renderReport() {
            const today = $('rec-date').value;
            const todayRecords = db.filter(r => r.date === today);
            const stats = calculateStats(todayRecords);

            $('rep-date-display').innerText = new Date(today).toLocaleDateString('th-TH', { dateStyle: 'long' });
            $('rep-total').innerText = stats.sumTotal.toLocaleString();
            $('rep-cust').innerText = stats.sumCust;
            $('rep-barber').innerText = Math.floor(stats.barberEarn).toLocaleString();
            $('rep-shop').innerText = Math.floor(stats.shopEarn).toLocaleString();
            $('rep-transfer').innerText = stats.sumTransfer.toLocaleString();

            const list = $('rep-list');
            list.innerHTML = '';
            todayRecords.slice().reverse().forEach(r => {
                list.innerHTML += `
                    <div class="card flex justify-between items-center">
                        <div class="flex-1">
                            <div class="font-bold text-sm">${r.services.join(' + ')} | ${r.style}</div>
                            <div class="text-[10px] text-gray-400">${r.start} - ${r.end} | <span class="${r.payType === 'cash' ? 'text-green-500' : 'text-blue-500'} font-bold">${r.payType === 'cash' ? '‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î' : '‡πÄ‡∏á‡∏¥‡∏ô‡πÇ‡∏≠‡∏ô'}</span></div>
                        </div>
                        <div class="text-right flex items-center gap-3">
                            <span class="font-bold text-lg">‡∏ø${r.total}</span>
                            <button onclick="deleteRecord(${r.id})" class="text-red-200 hover:text-red-500"><i class="fa-solid fa-trash-can"></i></button>
                        </div>
                    </div>
                `;
            });
        }

        function deleteRecord(id) {
            if(confirm("‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ?")) {
                db = db.filter(r => r.id !== id);
                localStorage.setItem('barber_note_db_v2', JSON.stringify(db));
                renderReport();
            }
        }

        function clearToday() {
            if(confirm("‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏Ç‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ? ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ß‡∏±‡∏ô‡∏≠‡∏∑‡πà‡∏ô‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏´‡∏≤‡∏¢")) {
                const today = $('rec-date').value;
                db = db.filter(r => r.date !== today);
                localStorage.setItem('barber_note_db_v2', JSON.stringify(db));
                renderReport();
            }
        }

        function renderHistory() {
            const selectedDate = $('his-date-select').value;
            const dailyRecords = db.filter(r => r.date === selectedDate);
            const stats = calculateStats(dailyRecords);
            const hisCard = $('his-daily-card');
            
            if(dailyRecords.length > 0) {
                hisCard.innerHTML = `
                    <div class="card bg-slate-800 text-white border-none p-5">
                        <div class="text-xs opacity-60 uppercase font-bold mb-1">${new Date(selectedDate).toLocaleDateString('th-TH', { dateStyle: 'full' })}</div>
                        <div class="flex justify-between items-end">
                            <div>
                                <div class="text-xs opacity-60">‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°</div>
                                <div class="text-3xl font-bold">‡∏ø${stats.sumTotal.toLocaleString()}</div>
                            </div>
                            <div class="text-right text-xs opacity-80">
                                <div>‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤: ${stats.sumCust}</div>
                                <div>‡∏ä‡πà‡∏≤‡∏á: ‡∏ø${Math.floor(stats.barberEarn)}</div>
                                <div>‡∏£‡πâ‡∏≤‡∏ô: ‡∏ø${Math.floor(stats.shopEarn)}</div>
                            </div>
                        </div>
                    </div>
                `;
            } else {
                hisCard.innerHTML = `<div class="p-10 text-center text-gray-300 text-sm">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</div>`;
            }

            // Monthly Stats
            const selMonth = selectedDate.slice(0, 7); // yyyy-mm
            const monthRecords = db.filter(r => r.date.startsWith(selMonth));
            const mTotal = monthRecords.reduce((s,r) => s + r.total, 0);
            
            const serviceMap = {};
            const styleMap = {};
            monthRecords.forEach(r => {
                r.services.forEach(s => serviceMap[s] = (serviceMap[s] || 0) + 1);
                styleMap[r.style] = (styleMap[r.style] || 0) + 1;
            });

            const topService = Object.entries(serviceMap).sort((a,b) => b[1]-a[1])[0] || ["-", 0];
            const topStyle = Object.entries(styleMap).sort((a,b) => b[1]-a[1])[0] || ["-", 0];

            $('his-month-stats').innerHTML = `
                <div class="card flex justify-between"><span>‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</span><span class="font-bold">‡∏ø${mTotal.toLocaleString()}</span></div>
                <div class="card flex justify-between"><span>‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏¢‡∏≠‡∏î‡∏ô‡∏¥‡∏¢‡∏°</span><span class="font-bold text-blue-600">${topService[0]} (${topService[1]})</span></div>
                <div class="card flex justify-between"><span>‡∏ó‡∏£‡∏á‡∏ú‡∏°‡∏¢‡∏≠‡∏î‡∏ô‡∏¥‡∏¢‡∏°</span><span class="font-bold text-emerald-600">${topStyle[0]} (${topStyle[1]})</span></div>
            `;
        }

        // Settings Logic
        function toggleSettings() { $('modal-set').classList.toggle('hidden'); }
        function updateTheme(t) { config.theme = t; }
        function updateBg(c) { config.bg = c; }
        function saveSettings() {
            config.shop = $('set-shop').value;
            config.percent = Number($('set-percent').value);
            config.guarantee = Number($('set-guarantee').value);
            localStorage.setItem('barber_note_cfg', JSON.stringify(config));
            applyConfig();
            toggleSettings();
        }

        window.onload = init;
    </script>
</body>
</html>
