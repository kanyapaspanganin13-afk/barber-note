<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-title" content="Barber Note">
<link rel="apple-touch-icon" href="https://i.ibb.co/27GqTXFn/Barber-Note.png">
<title>Barber Note v2.1</title>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600&display=swap" rel="stylesheet">

<style>
/* ===== LOCKED THEME SYSTEM ===== */
:root{ --primary:#2b459a; --bg:#f8fafc; --card:#ffffff; --text:#334155; --sub:#94a3b8; --border:#e2e8f0; }
.theme-blue{--primary:#2b459a}
.theme-dark{ --primary:#111827;--bg:#020617;--card:#020617; --text:#f8fafc;--border:#1e293b; }
.theme-green{--primary:#166534}
.bg-white{--bg:#ffffff} .bg-blue{--bg:#f0f9ff} .bg-green{--bg:#f0fdf4} .bg-yellow{--bg:#fefce8} .bg-pink{--bg:#fdf2f8} .bg-purple{--bg:#faf5ff} .bg-gray{--bg:#f8fafc}

/* ===== BASE ===== */
*{box-sizing:border-box;font-family:'Kanit',sans-serif; -webkit-tap-highlight-color: transparent;}
body{margin:0;background:var(--bg);color:var(--text);padding-bottom:80px}
.page{display:none;padding:14px;max-width:500px;margin:auto}
.page.active{display:block}
.header{ background:var(--card);border-bottom:1px solid var(--border); padding:14px;display:flex;justify-content:space-between;align-items:center }
.header .app{font-weight:600; font-size: 14px;}
.header .shop{color:var(--primary);font-weight:600}
.card{ background:var(--card);border:1px solid var(--border); border-radius:14px;padding:14px;margin-bottom:12px }
.label{font-size:13px;color:var(--sub);margin-bottom:6px}
input,select{ width:100%;padding:14px;font-size:16px; border-radius:12px;border:1px solid var(--border); background: var(--card); color: var(--text); }
.grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.btn{ width:100%;border:none;border-radius:14px; padding:16px;font-size:16px;font-weight:600; cursor: pointer; }
.btn.primary{background:var(--primary);color:#fff}
.btn.cash{background:#e5f0ff;color:#1e40af; border: 2px solid transparent;}
.btn.transfer{background:#dcfce7;color:#166534; border: 2px solid transparent;}
.btn.active{border-color: var(--primary);}
.nav{ position:fixed;bottom:0;width:100%;height:70px; display:flex;background:var(--card);border-top:1px solid var(--border) }
.nav div{ flex:1;text-align:center;padding-top:10px; font-size:12px;color:var(--sub); cursor: pointer; }
.nav .active{color:var(--primary);font-weight:600}
.svc-row{ display:grid;grid-template-columns:1fr 1fr 70px 30px; gap:6px;margin-bottom:8px; align-items: center; }
.hist{border:1px solid var(--border);border-radius:12px;padding:12px;margin-bottom:8px; background: var(--card); display: flex; justify-content: space-between; align-items: center;}

/* ===== REPORT (LOCKED) ===== */
.report-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px; margin-bottom: 15px;}
.report-card{ border:1px solid var(--border); border-radius:16px;padding:16px;background:var(--card); text-align: center; }
.big{font-size:26px;font-weight:600; margin: 4px 0;}
.mid{font-size:18px;font-weight:600}
.small{font-size:12px;color:var(--sub); font-weight: 400;}
.red-btn{ color: #ef4444; background: none; border: none; font-size: 14px; margin-top: 10px; width: 100%; }
</style>
</head>

<body>

<div id="rec" class="page active">
  <div class="header">
    <div>
      <div class="app">Barber Note</div>
      <div class="shop" id="shopName"></div>
    </div>
    <i class="fas fa-cog" onclick="go('set')"></i>
  </div>

  <div class="card">
    <div class="label">วันที่</div>
    <input type="date" id="recDate">
    <div class="grid2" style="margin-top:8px">
      <div><div class="label">เริ่ม</div><input type="time" id="start"></div>
      <div><div class="label">เสร็จ</div><input type="time" id="end"></div>
    </div>
  </div>

  <div class="card">
    <div class="label">บริการ / ทรงผม</div>
    <div id="svcList"></div>
    <div style="text-align: center; margin-top: 10px;">
        <small style="color:var(--primary); font-weight: 600;" onclick="addRow()">+ เพิ่มรายการ</small>
    </div>
  </div>

  <div class="grid2">
    <button id="btnCash" class="btn cash active" onclick="setPay('เงินสด')">เงินสด</button>
    <button id="btnTrans" class="btn transfer" onclick="setPay('โอนเงิน')">โอนเงิน</button>
  </div>

  <button class="btn primary" style="margin-top:12px" onclick="save()">SAVE RECORD</button>
</div>

<div id="rep" class="page">
  <div class="header"><div class="shop" id="shopNameRep"></div></div>

  <div class="report-grid">
    <div class="report-card">
      <div id="repDate" class="small"></div>
      <div class="small">ยอดตัดรวม</div>
      <div class="big" style="color:var(--primary)">฿ <span id="sumTotal">0</span></div>
      <div class="mid">ลูกค้า <span id="custCount">0</span></div>
    </div>

    <div class="report-card">
      <div class="small">รายได้ช่าง / ร้าน</div>
      <div class="mid">ช่าง ฿ <span id="barberIncome">0</span></div>
      <div class="mid">ร้าน ฿ <span id="shopIncome">0</span></div>
      <div class="small" style="border-top: 1px solid var(--border); margin-top: 8px; padding-top: 4px;">
        ยอดโอน ฿ <span id="transferTotal">0</span>
      </div>
    </div>
  </div>

  <div class="label">ประวัติงานวันนี้</div>
  <div id="repList"></div>
  <button class="red-btn" onclick="clearToday()">ล้างข้อมูลวันนี้ทั้งหมด</button>
</div>

<div id="his" class="page">
  <div class="header"><div class="shop">ประวัติย้อนหลัง</div></div>
  <div class="card">
    <input type="date" id="hisDate" onchange="renderHistory()">
  </div>
  <div id="hisSummary"></div>
  <div id="hisList"></div>
</div>

<div id="set" class="page">
  <div class="header"><div class="shop">ตั้งค่า</div></div>
  <div class="card">
    <div class="label">ชื่อร้าน / สาขา</div>
    <input id="shopInput">
  </div>
  <div class="grid2">
    <div class="card"><div class="label">% ช่าง</div><input type="number" id="percent"></div>
    <div class="card"><div class="label">ประกันรายวัน</div><input type="number" id="guarantee"></div>
  </div>
  <div class="card">
    <div class="label">ธีม</div>
    <select id="theme">
      <option value="theme-blue">Classic Blue</option>
      <option value="theme-dark">Dark Barber</option>
      <option value="theme-green">Green Minimal</option>
    </select>
    <div class="label" style="margin-top:10px">พื้นหลัง</div>
    <select id="bg">
      <option value="bg-white">ขาว</option><option value="bg-blue">ฟ้า</option><option value="bg-green">เขียว</option>
      <option value="bg-yellow">เหลือง</option><option value="bg-pink">ชมพู</option><option value="bg-purple">ม่วง</option><option value="bg-gray">เทา</option>
    </select>
  </div>
  <button class="btn primary" onclick="saveCfg()">บันทึกการตั้งค่า</button>
</div>

<div class="nav">
  <div id="n-rec" class="active" onclick="go('rec')"><i class="fas fa-cut"></i><br>บันทึก</div>
  <div id="n-rep" onclick="go('rep')"><i class="fas fa-file-invoice"></i><br>รายงาน</div>
  <div id="n-his" onclick="go('his')"><i class="fas fa-history"></i><br>ย้อนหลัง</div>
</div>

<script>
/* ===== LOCKED DATA & CONFIG ===== */
const SERVICES=["ตัดผม","โกนหนวด","กันหน้า","แก้ผม","สระผม","ย้อมผม","ดัดผม","ยืดผม","อื่นๆ"];
const STYLES=["รองทรง","แฟชั่น / ทูบล็อค","สกินเฟด","นักเรียน","ตำรวจ / ทหาร","ทรงอเมริกัน","เปิดข้าง / วินเทจ"];

let db=JSON.parse(localStorage.getItem("bn_db")||"[]");
let cfg=JSON.parse(localStorage.getItem("bn_cfg")|| '{"shop":"BARBER SHOP","percent":50,"guarantee":300,"theme":"theme-blue","bg":"bg-gray"}');
let pay="เงินสด";

function init(){
  document.body.className=cfg.theme+" "+cfg.bg;
  shopName.innerText=shopNameRep.innerText=cfg.shop;
  shopInput.value=cfg.shop; percent.value=cfg.percent; guarantee.value=cfg.guarantee;
  theme.value=cfg.theme; bg.value=cfg.bg;
  const today = new Date().toISOString().split("T")[0];
  recDate.value=hisDate.value=today;
  const now = new Date().toLocaleTimeString('th-TH',{hour:'2-digit',minute:'2-digit',hour12:false});
  start.value=end.value=now;
  addRow();
}

function addRow(){
  let d=document.createElement("div"); d.className="svc-row";
  d.innerHTML=`<select>${SERVICES.map(s=>`<option>${s}</option>`).join("")}</select>
    <select>${STYLES.map(s=>`<option>${s}</option>`).join("")}</select>
    <input type="number" value="150">
    <span style="color:#ccc" onclick="this.parentNode.remove()">✕</span>`;
  svcList.appendChild(d);
}

function setPay(t){
    pay=t;
    document.getElementById('btnCash').classList.toggle('active', t==='เงินสด');
    document.getElementById('btnTrans').classList.toggle('active', t==='โอนเงิน');
}

function save(){
  let total=0, count=0, items=[];
  document.querySelectorAll(".svc-row").forEach(r=>{
    let svc=r.children[0].value;
    let style=r.children[1].value;
    let p=parseInt(r.children[2].value)||0;
    total+=p;
    // สูตรพิเศษ: ทุกรายการนับเป็น 1 ลูกค้า (1 record) + รายการที่ไม่ใช่ตัดผม
    if(["โกนหนวด","สระผม","ย้อมผม"].includes(svc)) count+=1;
    items.push({svc,style,p});
  });
  // 1 record = 1 ลูกค้าพื้นฐาน
  let finalCust = 1 + count; 
  db.push({id:Date.now(),date:recDate.value,start:start.value,end:end.value,total,cust:finalCust,pay,items});
  localStorage.setItem("bn_db",JSON.stringify(db));
  svcList.innerHTML=""; addRow(); alert("บันทึกแล้ว");
}

function go(p){
  document.querySelectorAll(".page").forEach(x=>x.classList.remove("active"));
  document.querySelectorAll(".nav div").forEach(x=>x.classList.remove("active"));
  document.getElementById(p).classList.add("active");
  document.getElementById('n-'+p).classList.add("active");
  if(p==="rep")renderReport();
  if(p==="his")renderHistory();
}

function renderReport(){
  let d=recDate.value; let day=db.filter(x=>x.date===d);
  let sum=day.reduce((s,x)=>s+x.total,0);
  let cust=day.reduce((s,x)=>s+x.cust,0);
  let trans=day.reduce((s,x)=>x.pay==="โอนเงิน"?s+x.total:s,0);
  let barber=Math.max(cfg.guarantee, sum*cfg.percent/100);

  sumTotal.innerText=sum.toLocaleString();
  custCount.innerText=cust;
  barberIncome.innerText=Math.floor(barber).toLocaleString();
  shopIncome.innerText=Math.floor(sum-barber).toLocaleString();
  transferTotal.innerText=trans.toLocaleString();
  repDate.innerText=new Date(d).toLocaleDateString("th-TH",{dateStyle:"long"});

  repList.innerHTML=day.map(x=>`
    <div class="hist">
      <div><small>${x.start}-${x.end}</small><br><b>${x.items[0].svc}</b> ${x.items[0].style}</div>
      <div style="text-align:right">฿${x.total}<br><small>${x.pay}</small> <i class="fas fa-trash" style="color:#ddd;margin-left:8px" onclick="delRow(${x.id})"></i></div>
    </div>`).join("");
}

function delRow(id){ if(confirm("ลบรายการนี้?")){ db=db.filter(x=>x.id!==id); localStorage.setItem("bn_db",JSON.stringify(db)); renderReport(); } }
function clearToday(){ if(confirm("ลบข้อมูลวันนี้ทั้งหมด?")){ let d=recDate.value; db=db.filter(x=>x.date!==d); localStorage.setItem("bn_db",JSON.stringify(db)); renderReport(); } }

function renderHistory(){
  let d=hisDate.value; let day=db.filter(x=>x.date===d);
  let sum=day.reduce((s,x)=>s+x.total,0);
  let cust=day.reduce((s,x)=>s+x.cust,0);
  let trans=day.reduce((s,x)=>x.pay==="โอนเงิน"?s+x.total:s,0);
  let barber=Math.max(cfg.guarantee, sum*cfg.percent/100);

  hisSummary.innerHTML= sum > 0 ? `
    <div class="card report-grid" style="background:var(--primary); color:#fff; border:none">
        <div>วันที่: ${new Date(d).toLocaleDateString("th-TH",{dateStyle:"medium"})} <br>ยอดรวม: ฿${sum}</div>
        <div style="text-align:right">ช่าง: ฿${Math.floor(barber)}<br>ร้าน: ฿${Math.floor(sum-barber)}</div>
    </div>` : '<center style="padding:20px; color:#94a3b8">ไม่มีข้อมูล</center>';

  hisList.innerHTML=day.map(x=>`
    <div class="hist">
      <div><small>${x.start}-${x.end}</small><br><b>${x.items[0].svc}</b></div>
      <div style="text-align:right">฿${x.total}<br><small>${x.pay}</small></div>
    </div>`).join("");
}

function saveCfg(){
  cfg={ shop:shopInput.value, percent:+percent.value, guarantee:+guarantee.value, theme:theme.value, bg:bg.value };
  localStorage.setItem("bn_cfg",JSON.stringify(cfg));
  location.reload();
}

init();
</script>
</body>
</html>
