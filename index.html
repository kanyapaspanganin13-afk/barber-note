<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <link rel="apple-touch-icon" href="https://i.ibb.co/27GqTXFn/Barber-Note.png">
    <title>Barber Note v3 FINAL</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #1e3a8a; --accent: #16a34a; --danger: #dc2626; --info: #0284c7; --muted: #64748b;
            --bg-p1: #fdf2f8; --bg-p2: #f0fdf4; --bg-p3: #f0f9ff;
        }
        body { margin: 0; font-family: 'Kanit', sans-serif; background: var(--bg-p3); color: #1e293b; padding-bottom: 100px; transition: 0.3s; }
        header { padding: 15px; background: #fff; display: flex; align-items: center; border-bottom: 1px solid #e2e8f0; position: sticky; top:0; z-index:100; }
        header h1 { flex: 1; text-align: center; font-size: 20px; margin: 0; font-weight: 600; }
        .page { display: none; padding: 15px; animation: fadeIn 0.2s; }
        .page.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .card { background: #fff; border-radius: 18px; padding: 16px; margin-bottom: 12px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); }
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        label { font-size: 13px; font-weight: 600; color: var(--muted); margin-bottom: 5px; display: block; }
        input, select { width: 100%; padding: 12px; border-radius: 12px; border: 1px solid #cbd5e1; font-size: 16px; box-sizing: border-box; outline: none; }
        .svc-row { display: flex; gap: 8px; margin-bottom: 8px; align-items: center; }
        button { border: none; border-radius: 12px; padding: 12px; font-size: 15px; cursor: pointer; font-family: 'Kanit'; font-weight: 600; }
        .btn-save { background: var(--primary); color: white; width: 100%; }
        .btn-save.success { background: var(--accent) !important; }
        .btn-pay { border: 2px solid #e2e8f0; background: #fff; color: var(--muted); }
        .btn-pay.active-cash { border-color: #f59e0b; color: #f59e0b; background: #fffcf0; }
        .btn-pay.active-transfer { border-color: var(--primary); color: var(--primary); background: #f0f4ff; }
        .status-bar { width: 100%; padding: 14px; border-radius: 12px; text-align: center; font-weight: 700; margin: 10px 0; font-size: 18px; }
        .status-red { background: #fee2e2; color: #dc2626; }
        .status-green { background: #dcfce7; color: #16a34a; }
        .status-blue { background: #e0f2fe; color: #0284c7; }
        .nav { position: fixed; bottom: 0; left: 0; right: 0; background: #fff; display: flex; border-top: 1px solid #e2e8f0; padding-bottom: 25px; }
        .nav-item { flex: 1; text-align: center; padding: 12px; color: #94a3b8; }
        .nav-item.active { color: var(--primary); font-weight: 700; }
        .nav-item i { font-size: 22px; display: block; margin-bottom: 4px; }
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; z-index: 1000; }
        .modal-content { background: #fff; width: 85%; border-radius: 24px; padding: 25px; }
        .badge { background: #f1f5f9; padding: 3px 8px; border-radius: 8px; font-size: 11px; margin: 2px; display: inline-block; border: 1px solid #e2e8f0; }
    </style>
</head>
<body>

<header>
    <div style="width:30px"></div>
    <h1 id="shopTitleDisplay">‡∏£‡πâ‡∏≤‡∏ô‡∏ï‡∏±‡∏î‡∏ú‡∏°</h1>
    <div style="width:30px; text-align:right" onclick="toggleModal(true)"><i class="fas fa-cog"></i></div>
</header>

<div class="page active" id="p1">
    <div class="card">
        <label>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</label>
        <input type="date" id="dateInp">
    </div>
    <div class="card">
        <label>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£ & ‡∏ó‡∏£‡∏á‡∏ú‡∏°</label>
        <div id="svcList">
            <div class="svc-row">
                <select class="svc-sel">
                    <option>‡∏ï‡∏±‡∏î‡∏ú‡∏°</option><option>‡πÇ‡∏Å‡∏ô‡∏´‡∏ô‡∏ß‡∏î</option><option>‡∏Å‡∏±‡∏ô‡∏´‡∏ô‡πâ‡∏≤</option>
                    <option>‡πÅ‡∏Å‡πâ‡∏ú‡∏°</option><option>‡πÇ‡∏Å‡∏ô‡∏ú‡∏°</option><option>‡∏™‡∏£‡∏∞‡∏ú‡∏°</option>
                    <option>‡∏¢‡πâ‡∏≠‡∏°‡∏ú‡∏°</option><option>‡∏î‡∏±‡∏î‡∏ú‡∏°</option><option>‡∏≠‡∏∑‡πà‡∏ô‡πÜ</option>
                </select>
                <select class="hair-sel">
                    <option value="">(‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ó‡∏£‡∏á)</option><option>‡∏£‡∏≠‡∏á‡∏ó‡∏£‡∏á</option><option>‡∏™‡∏Å‡∏¥‡∏ô‡πÄ‡∏ü‡∏î</option>
                    <option>‡πÅ‡∏ü‡∏ä‡∏±‡πà‡∏ô</option><option>‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</option><option>‡∏ï‡∏≥‡∏£‡∏ß‡∏à / ‡∏ó‡∏´‡∏≤‡∏£</option>
                    <option>‡∏ó‡∏£‡∏á‡∏≠‡πÄ‡∏°‡∏£‡∏¥‡∏Å‡∏±‡∏ô</option><option>‡πÄ‡∏õ‡∏¥‡∏î‡∏Ç‡πâ‡∏≤‡∏á</option><option>‡∏ß‡∏¥‡∏ô‡πÄ‡∏ó‡∏à</option><option>‡∏≠‡∏∑‡πà‡∏ô‡πÜ</option>
                </select>
            </div>
        </div>
        <button onclick="addSvcField()" style="background:#f1f5f9; color:var(--primary); font-size:12px; padding:5px 10px; margin-bottom:15px; border-radius:8px;">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏™‡∏£‡∏¥‡∏°</button>
        <label>‡∏£‡∏≤‡∏Ñ‡∏≤‡∏Ñ‡πà‡∏≤‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏£‡∏ß‡∏°</label>
        <input type="number" id="priceInp" placeholder="0" inputmode="numeric" style="font-size:24px; font-weight:700; color:var(--primary);">
    </div>
    <div class="card">
        <label>‡∏ß‡∏¥‡∏ò‡∏µ‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</label>
        <div class="grid-2">
            <button id="bCash" class="btn-pay" onclick="setPay('‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î')">‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î</button>
            <button id="bTrans" class="btn-pay" onclick="setPay('‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô')">‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</button>
        </div>
    </div>
    <button id="saveBtn" class="btn-save" onclick="saveRecord()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
</div>

<div class="page" id="p2">
    <h2 id="todayDateLabel" style="text-align:center; margin:10px 0;"></h2>
    <div class="grid-2">
        <div class="card" style="border-left:5px solid var(--primary)">
            <label>‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</label>
            <div id="sumTotal" style="font-size:26px; font-weight:700">0</div>
            <div style="font-size:12px; color:var(--muted)">‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ <span id="sumCust">0</span> | ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£ <span id="sumEx">0</span></div>
        </div>
        <div class="card">
            <div style="font-size:12px">‡πÇ‡∏≠‡∏ô: <b id="sumTrans">0</b></div>
            <div style="font-size:12px">‡∏ä‡πà‡∏≤‡∏á: <b id="incBarber">0</b></div>
            <div style="font-size:12px">‡∏£‡πâ‡∏≤‡∏ô: <b id="incShop" style="color:var(--accent)">0</b></div>
        </div>
    </div>
    <div id="settlementBar" class="status-bar status-gray">‚ö™Ô∏è ‡∏¢‡∏≠‡∏î‡∏û‡∏≠‡∏î‡∏µ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Ñ‡∏∑‡∏ô</div>
    <div class="card">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <label>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</label>
            <i class="fab fa-line" style="color:#06C755; font-size:24px;" onclick="shareToLine()"></i>
        </div>
        <div id="todayRecords" style="margin-top:10px"></div>
        <button onclick="deleteDayRecords()" style="width:100%; margin-top:20px; color:var(--danger); background:none; font-size:12px;">‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏Ç‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</button>
    </div>
</div>

<div class="page" id="p3">
    <div class="card">
        <label>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</label>
        <div class="grid-2">
            <input type="date" id="histDate" onchange="showDailyHist()">
            <input type="month" id="histMonth" onchange="showMonthlyHist()">
        </div>
    </div>
    <div id="histContent"></div>
</div>

<div class="modal" id="setModal">
    <div class="modal-content">
        <h3 style="margin:0 0 15px 0;">‚öôÔ∏è ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</h3>
        <label>‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô</label><input id="sShop">
        <label>% ‡∏Ñ‡∏≠‡∏°‡∏°‡∏¥‡∏ä‡∏ä‡∏±‡πà‡∏ô</label><input type="number" id="sPerc">
        <label>‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô</label><input type="number" id="sGuar">
        <div class="grid-2" style="margin-top:20px">
            <button class="btn-pay" onclick="toggleModal(false)">‡∏õ‡∏¥‡∏î</button>
            <button class="btn-save" onclick="saveSettings()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
        </div>
    </div>
</div>

<nav class="nav">
    <div class="nav-item active" id="n1" onclick="go(1)"><i class="fas fa-edit"></i>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</div>
    <div class="nav-item" id="n2" onclick="go(2)"><i class="fas fa-calendar-day"></i>‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô</div>
    <div class="nav-item" id="n3" onclick="go(3)"><i class="fas fa-chart-line"></i>‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥</div>
</nav>

<script>
    let payType = "";
    let conf = JSON.parse(localStorage.getItem("bn3_conf")) || {shop:"‡∏£‡πâ‡∏≤‡∏ô‡∏ï‡∏±‡∏î‡∏ú‡∏°", perc:50, guar:0};
    let db = JSON.parse(localStorage.getItem("bn3_db")) || [];

    window.onload = () => {
        document.getElementById("dateInp").valueAsDate = new Date();
        document.getElementById("shopTitleDisplay").innerText = conf.shop;
    };

    function go(n) {
        document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
        document.querySelectorAll('.nav-item').forEach(i=>i.classList.remove('active'));
        document.getElementById('p'+n).classList.add('active');
        document.getElementById('n'+n).classList.add('active');
        if(n===2) renderTodayPage();
        if(n===3) showDailyHist();
    }

    function toggleModal(s) {
        document.getElementById("setModal").style.display = s?'flex':'none';
        if(s){ document.getElementById("sShop").value=conf.shop; document.getElementById("sPerc").value=conf.perc; document.getElementById("sGuar").value=conf.guar; }
    }

    function saveSettings() {
        conf = {shop:document.getElementById("sShop").value, perc:+document.getElementById("sPerc").value, guar:+document.getElementById("sGuar").value};
        localStorage.setItem("bn3_conf", JSON.stringify(conf));
        document.getElementById("shopTitleDisplay").innerText = conf.shop;
        toggleModal(false);
    }

    function addSvcField() {
        const div = document.createElement('div'); div.className = 'svc-row';
        div.innerHTML = `<select class="svc-sel"><option>‡πÇ‡∏Å‡∏ô‡∏´‡∏ô‡∏ß‡∏î</option><option>‡∏Å‡∏±‡∏ô‡∏´‡∏ô‡πâ‡∏≤</option><option>‡πÅ‡∏Å‡πâ‡∏ú‡∏°</option><option>‡πÇ‡∏Å‡∏ô‡∏ú‡∏°</option><option>‡∏™‡∏£‡∏∞‡∏ú‡∏°</option><option>‡∏¢‡πâ‡∏≠‡∏°‡∏ú‡∏°</option><option>‡∏î‡∏±‡∏î‡∏ú‡∏°</option><option>‡∏≠‡∏∑‡πà‡∏ô‡πÜ</option></select>
            <select class="hair-sel"><option value="">(‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ó‡∏£‡∏á)</option><option>‡∏£‡∏≠‡∏á‡∏ó‡∏£‡∏á</option><option>‡∏™‡∏Å‡∏¥‡∏ô‡πÄ‡∏ü‡∏î</option><option>‡πÅ‡∏ü‡∏ä‡∏±‡πà‡∏ô</option><option>‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</option><option>‡∏ï‡∏≥‡∏£‡∏ß‡∏à / ‡∏ó‡∏´‡∏≤‡∏£</option><option>‡∏ó‡∏£‡∏á‡∏≠‡πÄ‡∏°‡∏£‡∏¥‡∏Å‡∏±‡∏ô</option><option>‡πÄ‡∏õ‡∏¥‡∏î‡∏Ç‡πâ‡∏≤‡∏á</option><option>‡∏ß‡∏¥‡∏ô‡πÄ‡∏ó‡∏à</option><option>‡∏≠‡∏∑‡πà‡∏ô‡πÜ</option></select>
            <button onclick="this.parentElement.remove()" style="background:none; color:red;">‚úï</button>`;
        document.getElementById('svcList').appendChild(div);
    }

    function setPay(t) {
        payType = t;
        document.getElementById("bCash").className = t==='‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î'?'btn-pay active-cash':'btn-pay';
        document.getElementById("bTrans").className = t==='‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô'?'btn-pay active-transfer':'btn-pay';
    }

    function saveRecord() {
        const price = document.getElementById("priceInp").value;
        if(!price || !payType) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏£‡∏≤‡∏Ñ‡∏≤‡πÅ‡∏•‡∏∞‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏≤‡∏£‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏á‡∏¥‡∏ô");
        const entry = {
            id: Date.now(), date: document.getElementById("dateInp").value,
            services: Array.from(document.querySelectorAll('.svc-sel')).map(s=>s.value),
            hairs: Array.from(document.querySelectorAll('.hair-sel')).map(h=>h.value).filter(v=>v!==""),
            price: +price, pay: payType
        };
        db.push(entry); localStorage.setItem("bn3_db", JSON.stringify(db));
        const btn = document.getElementById("saveBtn"); btn.classList.add("success"); btn.innerText = "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‚úÖ";
        setTimeout(()=>{
            btn.classList.remove("success"); btn.innerText = "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•";
            document.getElementById("priceInp").value=""; setPay("");
            document.getElementById("svcList").innerHTML = `<div class="svc-row"><select class="svc-sel"><option>‡∏ï‡∏±‡∏î‡∏ú‡∏°</option><option>‡πÇ‡∏Å‡∏ô‡∏´‡∏ô‡∏ß‡∏î</option><option>‡∏Å‡∏±‡∏ô‡∏´‡∏ô‡πâ‡∏≤</option><option>‡πÅ‡∏Å‡πâ‡∏ú‡∏°</option><option>‡πÇ‡∏Å‡∏ô‡∏ú‡∏°</option><option>‡∏™‡∏£‡∏∞‡∏ú‡∏°</option><option>‡∏¢‡πâ‡∏≠‡∏°‡∏ú‡∏°</option><option>‡∏î‡∏±‡∏î‡∏ú‡∏°</option><option>‡∏≠‡∏∑‡πà‡∏ô‡πÜ</option></select><select class="hair-sel"><option value="">(‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ó‡∏£‡∏á)</option><option>‡∏£‡∏≠‡∏á‡∏ó‡∏£‡∏á</option><option>‡∏™‡∏Å‡∏¥‡∏ô‡πÄ‡∏ü‡∏î</option><option>‡πÅ‡∏ü‡∏ä‡∏±‡πà‡∏ô</option><option>‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</option><option>‡∏ï‡∏≥‡∏£‡∏ß‡∏à / ‡∏ó‡∏´‡∏≤‡∏£</option><option>‡∏ó‡∏£‡∏á‡∏≠‡πÄ‡∏°‡∏£‡∏¥‡∏Å‡∏±‡∏ô</option><option>‡πÄ‡∏õ‡∏¥‡∏î‡∏Ç‡πâ‡∏≤‡∏á</option><option>‡∏ß‡∏¥‡∏ô‡πÄ‡∏ó‡∏à</option><option>‡∏≠‡∏∑‡πà‡∏ô‡πÜ</option></select></div>`;
        }, 800);
    }

    function renderTodayPage() {
        const today = document.getElementById("dateInp").value;
        const filtered = db.filter(r => r.date === today);
        let total = 0, trans = 0, svccnt = 0, html = "";
        filtered.forEach(r => {
            total += r.price; if(r.pay==='‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô') trans += r.price;
            svccnt += r.services.length;
            html += `<div style="display:flex; justify-content:space-between; padding:8px 0; border-bottom:1px solid #eee; font-size:14px;">
                <span>${r.services.join('+')} <small style="color:var(--muted)">${r.hairs.join(',')}</small></span>
                <span><b>${r.price}</b> <i class="fas fa-trash" style="color:#ccc; margin-left:8px;" onclick="delRec(${r.id})"></i></span>
            </div>`;
        });
        const barber = Math.max(total * (conf.perc/100), conf.guar);
        const shop = total - barber;
        const diff = trans - shop;

        document.getElementById("todayDateLabel").innerText = new Date(today).toLocaleDateString('th-TH',{day:'numeric',month:'long',year:'numeric'});
        document.getElementById("sumTotal").innerText = total.toLocaleString();
        document.getElementById("sumCust").innerText = filtered.length;
        document.getElementById("sumEx").innerText = svccnt;
        document.getElementById("sumTrans").innerText = trans.toLocaleString();
        document.getElementById("incBarber").innerText = barber.toLocaleString();
        document.getElementById("incShop").innerText = shop.toLocaleString();
        document.getElementById("todayRecords").innerHTML = html || "<center style='color:#ccc; padding:20px;'>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</center>";

        const bar = document.getElementById("settlementBar");
        if(total===0) { bar.innerText="‚ö™Ô∏è ‡∏¢‡∏≠‡∏î‡∏û‡∏≠‡∏î‡∏µ"; bar.className="status-bar status-gray"; }
        else if(diff > 0) { bar.innerText=`üü• ‡∏ä‡πà‡∏≤‡∏á‡∏Ñ‡∏∑‡∏ô‡∏£‡πâ‡∏≤‡∏ô ‡∏ø${diff.toLocaleString()}`; bar.className="status-bar status-red"; }
        else if(diff < 0) { bar.innerText=`üü© ‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡∏∑‡∏ô‡∏ä‡πà‡∏≤‡∏á ‡∏ø${Math.abs(diff).toLocaleString()}`; bar.className="status-bar status-green"; }
        else { bar.innerText="üîµ ‡∏¢‡∏≠‡∏î‡∏û‡∏≠‡∏î‡∏µ"; bar.className="status-bar status-blue"; }
    }

    function delRec(id) { if(confirm("‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ?")){ db=db.filter(r=>r.id!==id); localStorage.setItem("bn3_db", JSON.stringify(db)); renderTodayPage(); } }
    function deleteDayRecords() { if(confirm("‡∏•‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏Ç‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ?")){ const t=document.getElementById("dateInp").value; db=db.filter(r=>r.date!==t); localStorage.setItem("bn3_db", JSON.stringify(db)); renderTodayPage(); } }

    function showDailyHist() {
        const d = document.getElementById("histDate").value || document.getElementById("dateInp").value;
        const filtered = db.filter(r => r.date === d);
        let total = 0, trans = 0, svccnt = 0, html = "";
        filtered.forEach(r => { 
            total += r.price; if(r.pay==='‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô') trans += r.price; svccnt += r.services.length; 
            html += `<div style="font-size:12px; border-bottom:1px solid #f1f5f9; padding:4px 0;">${r.services.join('+')} (${r.price})</div>`;
        });
        const barber = Math.max(total * (conf.perc/100), conf.guar);
        const shop = total - barber;
        const diff = trans - shop;
        const status = diff > 0 ? `<span style="color:red">‡∏ä‡πà‡∏≤‡∏á‡∏Ñ‡∏∑‡∏ô‡∏£‡πâ‡∏≤‡∏ô ‡∏ø${diff}</span>` : diff < 0 ? `<span style="color:green">‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡∏∑‡∏ô‡∏ä‡πà‡∏≤‡∏á ‡∏ø${Math.abs(diff)}</span>` : "‡∏¢‡∏≠‡∏î‡∏û‡∏≠‡∏î‡∏µ";

        document.getElementById("histContent").innerHTML = `
            <div class="card">
                <h3 style="margin:0">${new Date(d).toLocaleDateString('th-TH')}</h3>
                <div class="grid-2" style="margin-top:10px; font-size:14px;">
                    <div><b>‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°:</b> ‡∏ø${total}</div><div><b>‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤:</b> ${filtered.length} ‡∏Ñ‡∏ô</div>
                    <div><b>‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£:</b> ${svccnt} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</div><div><b>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞:</b> ${status}</div>
                    <div><b>‡∏ä‡πà‡∏≤‡∏á‡πÑ‡∏î‡πâ:</b> ‡∏ø${barber}</div><div><b>‡∏£‡πâ‡∏≤‡∏ô‡πÑ‡∏î‡πâ:</b> ‡∏ø${shop}</div>
                </div>
                <div style="margin-top:10px; border-top:1px solid #eee; padding-top:10px;">${html || "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•"}</div>
            </div>`;
    }

    function showMonthlyHist() {
        const m = document.getElementById("histMonth").value; if(!m) return;
        const filtered = db.filter(r => r.date.startsWith(m));
        let total = 0, bTotal = 0, svcs = {}, hairs = {};
        const days = [...new Set(filtered.map(r=>r.date))];
        
        days.forEach(d => {
            const daySum = filtered.filter(r=>r.date===d).reduce((a,b)=>a+b.price,0);
            bTotal += Math.max(daySum * (conf.perc/100), conf.guar);
        });
        filtered.forEach(r => { 
            total += r.price; 
            r.services.forEach(s => svcs[s] = (svcs[s]||0)+1);
            r.hairs.forEach(h => hairs[h] = (hairs[h]||0)+1);
        });

        const svcSorted = Object.entries(svcs).sort((a,b)=>b[1]-a[1]).map(e=>`<span class="badge">${e[0]} (${e[1]})</span>`).join('');
        const hairSorted = Object.entries(hairs).sort((a,b)=>b[1]-a[1]).map(e=>`<span class="badge">${e[0]} (${e[1]})</span>`).join('');

        document.getElementById("histContent").innerHTML = `
            <div class="card" style="border-top:5px solid var(--primary)">
                <h3>‡∏™‡∏£‡∏∏‡∏õ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô ${m}</h3>
                <div style="font-size:15px;">
                    ‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°: <b style="font-size:20px; color:var(--primary)">‡∏ø${total.toLocaleString()}</b><br>
                    ‡∏ä‡πà‡∏≤‡∏á: ‡∏ø${bTotal.toLocaleString()} | ‡∏£‡πâ‡∏≤‡∏ô: ‡∏ø${(total-bTotal).toLocaleString()}<br>
                    ‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢: ‡∏ø${(total/(days.length||1)).toFixed(0)} /‡∏ß‡∏±‡∏ô | ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤: ${filtered.length} ‡∏Ñ‡∏ô
                </div>
                <label style="margin-top:15px">‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏¢‡∏≠‡∏î‡∏ô‡∏¥‡∏¢‡∏°</label><div>${svcSorted || '-'}</div>
                <label style="margin-top:10px">‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö‡∏ó‡∏£‡∏á‡∏ú‡∏°‡∏¢‡∏≠‡∏î‡∏ô‡∏¥‡∏¢‡∏°</label><div>${hairSorted || '-'}</div>
            </div>`;
    }

    function shareToLine() {
        const today = document.getElementById("dateInp").value;
        const filtered = db.filter(r => r.date === today);
        if(!filtered.length) return alert("‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡πÅ‡∏ä‡∏£‡πå");
        let total = 0, trans = 0, detail = "";
        filtered.forEach((r,i) => { total += r.price; if(r.pay==='‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô') trans += r.price; detail += `${i+1}. ${r.services.join('+')} (${r.price})\n`; });
        const barber = Math.max(total * (conf.perc/100), conf.guar);
        const shop = total - barber;
        const diff = trans - shop;
        const status = diff > 0 ? "‡∏ä‡πà‡∏≤‡∏á‡∏Ñ‡∏∑‡∏ô‡∏£‡πâ‡∏≤‡∏ô" : diff < 0 ? "‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡∏∑‡∏ô‡∏ä‡πà‡∏≤‡∏á" : "‡∏¢‡∏≠‡∏î‡∏û‡∏≠‡∏î‡∏µ";
        const msg = `üìÖ ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô: ${today}\nüí∞ ‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°: ${total}\nü§µ ‡∏ä‡πà‡∏≤‡∏á: ${barber} / üè† ‡∏£‡πâ‡∏≤‡∏ô: ${shop}\nüîÑ ${status}: ${Math.abs(diff)}\n\nüìù ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£:\n${detail}`;
        window.open(`https://line.me/R/msg/text/?${encodeURIComponent(msg)}`);
    }
</script>
</body>
</html>
