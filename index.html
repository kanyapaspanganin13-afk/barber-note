<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
 
    <link rel="apple-touch-icon" href="https://i.ibb.co/27GqTXFn/Barber-Note.png">
    <link rel="icon" type="image/png" href="https://i.ibb.co/27GqTXFn/Barber-Note.png">
    
   <meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Barber Note">

<meta name="mobile-web-app-capable" content="yes">
    <title>Barber Note Pro V6.2</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@200;300;400;500;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #2b459a;
            --bg: #f8fafc;
            --card: #ffffff;
            --text: #334155;
            --sub: #94a3b8;
            --border: #e2e8f0;
            --green: #22c55e;
            --red: #ef4444;
            --orange: #f59e0b;
            --font-size: 16px;
        }

        * { box-sizing: border-box; font-family: 'Kanit', sans-serif; -webkit-tap-highlight-color: transparent; }
        body { background-color: var(--bg); color: var(--text); font-size: var(--font-size); margin: 0; padding-bottom: 90px; transition: 0.4s ease; }

        .page { display: none; padding: 15px; max-width: 500px; margin: auto; }
        .page.active { display: block; }

        .header { background: var(--card); padding: 20px; text-align: center; border-bottom: 1px solid var(--border); margin-bottom: 15px; }
        .header .branch { font-weight: 600; color: var(--primary); font-size: 1.3rem; letter-spacing: 1px; }

        .card { background: var(--card); border-radius: 16px; padding: 15px; margin-bottom: 12px; border: 1px solid var(--border); box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); }
        .label { font-size: 0.75rem; color: var(--sub); font-weight: 600; margin-bottom: 6px; display: block; text-transform: uppercase; }

        input, select { 
            width: 100%; border: 1px solid var(--border); border-radius: 10px; padding: 12px; 
            font-size: 1rem; outline: none; background: #fdfdfd; color: var(--text); appearance: none;
        }
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }

        .svc-item { display: grid; grid-template-columns: 1fr 1fr 70px 30px; gap: 8px; margin-bottom: 10px; align-items: center; }
        .btn-remove-row { color: var(--red); opacity: 0.6; cursor: pointer; text-align: center; font-size: 1.2rem; }
        
        .btn-add { color: var(--primary); font-size: 0.85rem; font-weight: 600; cursor: pointer; display: inline-block; margin-top: 5px; padding: 5px 0; }

        .pay-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin: 15px 0; }
        .pay-btn { 
            padding: 14px; border-radius: 12px; border: 1px solid var(--border); background: var(--card); 
            text-align: center; cursor: pointer; font-weight: 500; color: var(--sub);
        }
        .pay-btn.active { background: var(--primary); color: white; border-color: var(--primary); box-shadow: 0 4px 10px rgba(43, 69, 154, 0.2); }

        .btn-main { 
            width: 100%; background: var(--primary); color: white; border: none; padding: 18px; 
            border-radius: 14px; font-size: 1.1rem; font-weight: 600; transition: 0.3s; cursor: pointer;
        }
        .btn-main.success { background: var(--green) !important; }

        .rep-summary { display: grid; grid-template-columns: 1.1fr 0.9fr; gap: 10px; margin-bottom: 15px; }
        .box-blue { background: var(--primary); color: white; padding: 15px; border-radius: 16px; display: flex; flex-direction: column; justify-content: center; }
        .box-white { background: var(--card); border: 1px solid var(--border); padding: 12px; border-radius: 16px; display: flex; flex-direction: column; justify-content: center; }
        .sub-stat { display: flex; justify-content: space-between; font-size: 0.85rem; border-bottom: 1px solid #f1f5f9; padding: 6px 0; }
        
        .status-bar { padding: 14px; border-radius: 12px; text-align: center; font-weight: 600; margin-bottom: 15px; font-size: 0.95rem; }
        .status-bar.green { background: #dcfce7; color: #166534; }
        .status-bar.blue { background: #dbeafe; color: #1e40af; }
        .status-bar.orange { background: #ffedd5; color: #9a3412; }

        .hist-card { background: var(--card); border-radius: 12px; padding: 15px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; border: 1px solid var(--border); }
        .hist-del { color: var(--red); opacity: 0.3; padding: 10px; cursor: pointer; }

        .theme-container { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 10px; }
        .theme-dot { width: 38px; height: 38px; border-radius: 10px; cursor: pointer; border: 3px solid #fff; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }

        .nav { position: fixed; bottom: 0; width: 100%; background: var(--card); display: flex; border-top: 1px solid var(--border); height: 75px; z-index: 100; }
        .nav-item { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; color: var(--sub); cursor: pointer; font-size: 0.75rem; }
        .nav-item.active { color: var(--primary); }
        .nav-item i { font-size: 1.3rem; margin-bottom: 4px; }

        .btn-clear { width: 100%; color: var(--red); background: none; border: none; padding: 20px; font-size: 0.8rem; font-weight: 600; opacity: 0.5; cursor: pointer; }
        
        .report-shop-name { text-align: center; font-weight: 700; font-size: 1.8rem; color: var(--primary); margin-bottom: 2px; text-transform: uppercase; }
        .report-date { text-align: center; font-size: 0.9rem; color: var(--sub); margin-bottom: 15px; border-bottom: 2px dashed var(--border); padding-bottom: 10px; }
    </style>
</head>
<body>

    <div id="page-rec" class="page active">
        <header class="header">
            <div class="branch" id="head-shop-rec">BARBER SHOP</div>
        </header>

       <div id="page-history" class="page">
        <header class="header">
            <div class="branch" id="head-shop-hist">BARBER SHOP</div>
            <div style="font-size: 0.8rem; color: var(--sub);">ประวัติย้อนหลัง</div>
        </header>

        <div class="card">
            <label class="label">เลือกวันที่ดูประวัติ</label>
            <input type="date" id="hist-date-select" onchange="renderHistoryPage()">
            
            <button onclick="renderMonthlySummary()" style="width:100%; margin-top:10px; background:var(--orange); color:white; border:none; padding:12px; border-radius:10px; font-weight:600; cursor:pointer;">
                <i class="fas fa-calendar-alt"></i> ดูสรุปยอดรวมทั้งเดือนนี้
            </button>
        </div>

        <div id="hist-page-container"></div>
    </div>
            <input type="date" id="rec-date-raw" style="margin-bottom: 10px;">
            <div class="grid-2">
                <div><label class="label">เวลาเริ่ม</label><input type="time" id="rec-start"></div>
                <div><label class="label">เวลาเสร็จ</label><input type="time" id="rec-end"></div>
            </div>
        </div>

        <div class="card">
            <label class="label">เลือกบริการ</label>
            <div id="svc-list"></div>
            <div class="btn-add" onclick="addSvcRow()"><i class="fas fa-plus-circle"></i> เพิ่มบริการ</div>
        </div>

        <div class="pay-grid">
            <div class="pay-btn active" id="p-cash" onclick="setPay('เงินสด')">เงินสด</div>
            <div class="pay-btn" id="p-trans" onclick="setPay('โอนเงิน')">โอนเงิน</div>
        </div>

        <button class="btn-main" id="btn-save" onclick="saveRecord()">SAVE RECORD</button>
    </div>

    <div id="page-rep" class="page">
        <div class="report-shop-name" id="head-shop-rep">BARBER SHOP</div>
        <div id="rep-date-th" class="report-date">Loading...</div>
        
        <div class="rep-summary">
            <div class="box-blue">
                <div class="label" style="color: rgba(255,255,255,0.7); margin-bottom: 2px;">ยอดเงินรวม</div>
                <div style="font-size: 1.8rem; font-weight: 700; margin-bottom: 5px;">฿<span id="r-total">0</span></div>
                
                <div style="font-size: 0.85rem; border-top: 1px solid rgba(255,255,255,0.2); padding-top: 5px; margin-top: 2px;">
                    ลูกค้า <b><span id="r-count">0</span></b> คน
                </div>
                <div style="font-size: 0.7rem; opacity: 0.85; margin-top: 2px;">
                   โกน <span id="c-shave">0</span> | สระ <span id="c-wash">0</span> |  ย้อม <span id="c-color">0</span>
                </div>
            </div>

            <div class="box-white">
                <div class="sub-stat"><span>โอนรวม</span><b id="r-trans">0</b></div>
                <div class="sub-stat"><span>รายได้ช่าง</span><b id="r-barber">0</b></div>
                <div class="sub-stat"><span>รายได้ร้าน</span><b id="r-shop">0</b></div>
            </div>
        </div>

        <div id="status-bar" class="status-bar">...</div>

        <div id="hist-container"></div>
        <button class="btn-clear" onclick="clearData()">ล้างข้อมูลวันนี้</button>
    </div>

    <div id="page-history" class="page">
        <header class="header">
            <div class="branch" id="head-shop-hist">BARBER SHOP</div>
            <div style="font-size: 0.8rem; color: var(--sub);">ประวัติย้อนหลัง</div>
        </header>
        <div class="card">
            <label class="label">เลือกวันที่ดูประวัติ</label>
            <input type="date" id="hist-date-select" onchange="renderHistoryPage()">
        </div>
        <div id="hist-page-container"></div>
    </div>

    <div id="page-set" class="page">
        <header class="header">
            <div class="branch">ตั้งค่า & ธีม</div>
        </header>
        <div class="card">
            <label class="label">ชื่อร้าน/สาขา (สำหรับแคปจอ)</label>
            <input type="text" id="s-name" onchange="updateConfig()" placeholder="ระบุชื่อร้านที่นี่">
            <label class="label" style="margin-top:15px;">ระบบคำนวณรายได้</label>
            <select id="s-mode" onchange="updateConfig()">
                <option value="percent">แบ่งเปอร์เซ็นต์ (ออโต้ประกัน)</option>
                <option value="guarantee">ประกันรายได้ขั้นต่ำ (ฟิกซ์)</option>
            </select>
            <div class="grid-2" style="margin-top:15px;">
                <div>
                    <label class="label">เปอร์เซ็นต์ (%)</label>
                    <input type="number" id="s-percent" onchange="updateConfig()">
                </div>
                <div>
                    <label class="label">ประกัน (฿)</label>
                    <input type="number" id="s-guarantee" onchange="updateConfig()">
                </div>
            </div>
        </div>
        <div class="card">
            <label class="label">เลือกสีธีมพาสเทล</label>
            <div class="theme-container">
                <div class="theme-dot" style="background:#A7C7E7;" onclick="setTheme('#2b459a', '#f0f4f8')"></div>
                <div class="theme-dot" style="background:#C1E1C1;" onclick="setTheme('#3e7c3e', '#f2f8f2')"></div>
                <div class="theme-dot" style="background:#FAC898;" onclick="setTheme('#a66d32', '#fffaf5')"></div>
                <div class="theme-dot" style="background:#FFB7CE;" onclick="setTheme('#b33951', '#fff5f7')"></div>
                <div class="theme-dot" style="background:#B19CD9;" onclick="setTheme('#5a448a', '#f8f5ff')"></div>
            </div>
            <label class="label" style="margin-top:20px;">ขนาดตัวอักษร</label>
            <select id="s-font" onchange="updateConfig()">
                <option value="14px">เล็ก</option>
                <option value="16px">ปกติ</option>
                <option value="18px">ใหญ่</option>
            </select>
        </div>
    </div>

    <nav class="nav">
        <div class="nav-item active" id="n-rec" onclick="showPage('rec')"><i class="fas fa-edit"></i><span>บันทึก</span></div>
        <div class="nav-item" id="n-rep" onclick="showPage('rep')"><i class="fas fa-file-invoice-dollar"></i><span>สรุปงาน</span></div>
        <div class="nav-item" id="n-history" onclick="showPage('history')"><i class="fas fa-history"></i><span>ย้อนหลัง</span></div>
        <div class="nav-item" id="n-set" onclick="showPage('set')"><i class="fas fa-cog"></i><span>ตั้งค่า</span></div>
    </nav>

   <script>
    const svcs = ["", "ตัดผม", "โกนหนวด", "กันหน้า", "สระผม", "ย้อมผม", "แก้ผม", "ดัดผม", "ยืดผม", "อื่นๆ"];
    const styles = ["", "รองทรง", "แฟชั่น / ทูบล็อค", "สกินเฟด", "นักเรียน", "ตำรวจ / ทหาร", "ทรงอเมริกัน", "วินเทจ"];
    
    let db = JSON.parse(localStorage.getItem('barber_v6_db') || '[]');
    let cfg = JSON.parse(localStorage.getItem('barber_v6_cfg') || '{"name":"BARBER SHOP","mode":"percent","percent":50,"guarantee":300,"font":"16px","primary":"#2b459a","bg":"#f8fafc"}');
    let payType = 'เงินสด';

    window.onload = () => {
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('rec-date-raw').value = today;
        document.getElementById('hist-date-select').value = today;
        document.getElementById('rec-start').value = new Date().toTimeString().slice(0,5);
        applyConfig();
        addSvcRow();
    };

    // --- ฟังก์ชันบันทึกและจัดการพื้นฐาน (คงเดิม) ---
    function addSvcRow() {
        const container = document.getElementById('svc-list');
        const div = document.createElement('div');
        div.className = 'svc-item';
        div.innerHTML = `
            <select class="i-svc">${svcs.map(s => `<option value="${s}">${s}</option>`).join('')}</select>
            <select class="i-style">${styles.map(s => `<option value="${s}">${s}</option>`).join('')}</select>
            <input type="number" class="i-price" placeholder="ราคา" value="${container.children.length === 0 ? '150' : ''}">
            <div class="btn-remove-row" onclick="removeSvcRow(this)"><i class="fas fa-times-circle"></i></div>
        `;
        container.appendChild(div);
    }

    function removeSvcRow(el) {
        const container = document.getElementById('svc-list');
        if (container.children.length > 1) el.parentElement.remove();
    }

    function applyConfig() {
        const shopNames = ['head-shop-rec', 'head-shop-rep', 'head-shop-hist'];
        shopNames.forEach(id => { if(document.getElementById(id)) document.getElementById(id).innerText = cfg.name; });
        document.getElementById('s-name').value = cfg.name;
        document.getElementById('s-mode').value = cfg.mode;
        document.getElementById('s-percent').value = cfg.percent;
        document.getElementById('s-guarantee').value = cfg.guarantee;
        document.getElementById('s-font').value = cfg.font;
        document.documentElement.style.setProperty('--primary', cfg.primary);
        document.documentElement.style.setProperty('--bg', cfg.bg);
        document.documentElement.style.setProperty('--font-size', cfg.font);
    }

    function updateConfig() {
        cfg.name = document.getElementById('s-name').value || "BARBER SHOP";
        cfg.mode = document.getElementById('s-mode').value;
        cfg.percent = parseInt(document.getElementById('s-percent').value) || 0;
        cfg.guarantee = parseInt(document.getElementById('s-guarantee').value) || 0;
        cfg.font = document.getElementById('s-font').value;
        localStorage.setItem('barber_v6_cfg', JSON.stringify(cfg));
        applyConfig();
    }

    function setTheme(p, b) { cfg.primary = p; cfg.bg = b; updateConfig(); }

    function setPay(t) {
        payType = t;
        document.getElementById('p-cash').classList.toggle('active', t === 'เงินสด');
        document.getElementById('p-trans').classList.toggle('active', t === 'โอนเงิน');
    }

    function saveRecord() {
        const rows = document.querySelectorAll('.svc-item');
        let items = []; let total = 0;
        rows.forEach(r => {
            const p = parseInt(r.querySelector('.i-price').value) || 0;
            if(p > 0) {
                items.push({ svc: r.querySelector('.i-svc').value, style: r.querySelector('.i-style').value, price: p });
                total += p;
            }
        });
        if(total === 0) return alert('กรุณาใส่ราคา');
        const entry = {
            id: Date.now(),
            date: document.getElementById('rec-date-raw').value,
            time: document.getElementById('rec-start').value + '-' + (document.getElementById('rec-end').value || '??'),
            items: items, total: total, pay: payType
        };
        db.push(entry);
        localStorage.setItem('barber_v6_db', JSON.stringify(db));
        const btn = document.getElementById('btn-save');
        btn.classList.add('success'); btn.innerHTML = '<i class="fas fa-check"></i> บันทึกสำเร็จ';
        setTimeout(() => {
            btn.classList.remove('success'); btn.innerHTML = 'SAVE RECORD';
            document.getElementById('svc-list').innerHTML = ''; addSvcRow();
        }, 1000);
    }

    function showPage(p) {
        document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
        document.getElementById('page-' + p).classList.add('active');
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        if(document.getElementById('n-' + p)) document.getElementById('n-' + p).classList.add('active');
        if(p === 'rep') renderReport();
        if(p === 'history') renderHistoryPage();
    }

    function formatDateBE(dateStr) {
        const d = new Date(dateStr);
        const months = ["ม.ค.", "ก.พ.", "มี.ค.", "เม.ย.", "พ.ค.", "มิ.ย.", "ก.ค.", "ส.ค.", "ก.ย.", "ต.ค.", "พ.ย.", "ธ.ค."];
        return `${d.getDate()} ${months[d.getMonth()]} ${d.getFullYear() + 543}`;
    }

    // --- ส่วนแสดงผลรายงานและประวัติ (ปรับปรุงใหม่) ---

    function renderReport() {
        const targetDate = document.getElementById('rec-date-raw').value;
        renderDataView(targetDate, 'hist-container', 'r-total', 'r-count', 'r-trans', 'r-barber', 'r-shop', 'c-wash', 'c-shave', 'c-color', 'status-bar', 'rep-date-th');
    }

    function renderHistoryPage() {
        const targetDate = document.getElementById('hist-date-select').value;
        const container = document.getElementById('hist-page-container');
        const data = db.filter(r => r.date === targetDate);
        
        // กวาดนับบริการทั้งหมดที่มีในวันนั้น
        let svcCount = {};
        let sumTotal = 0;
        data.forEach(r => {
            sumTotal += r.total;
            r.items.forEach(it => {
                if(it.svc) svcCount[it.svc] = (svcCount[it.svc] || 0) + 1;
            });
        });

        // คำนวณส่วนแบ่ง
        let barber = cfg.mode === 'percent' ? Math.max(cfg.guarantee, (sumTotal * cfg.percent / 100)) : cfg.guarantee;
        if(sumTotal === 0) barber = 0;
        let shop = sumTotal - barber;

        // สร้าง HTML สรุป
        let summaryHTML = `
            <div class="card" style="background: var(--primary); color: white; border: none; margin-bottom:15px;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div><div class="label" style="color:rgba(255,255,255,0.7);">ยอดรวม</div><div style="font-size:1.6rem; font-weight:700;">฿${sumTotal.toLocaleString()}</div></div>
                    <div style="text-align:right;"><div class="label" style="color:rgba(255,255,255,0.7);">ลูกค้า</div><div style="font-size:1.6rem; font-weight:700;">${data.length} คน</div></div>
                </div>
                <div style="margin-top:12px; padding-top:10px; border-top:1px solid rgba(255,255,255,0.2); font-size:0.85rem;">
                    <b>สรุปบริการ:</b> ${Object.entries(svcCount).map(([name, count]) => `${name} (${count})`).join(' | ') || 'ไม่มีข้อมูล'}
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px; font-size: 0.9rem; background: rgba(255,255,255,0.15); padding: 10px; border-radius: 10px;">
                    <div>ช่าง: <b>฿${Math.floor(barber).toLocaleString()}</b></div>
                    <div style="text-align: right;">ร้าน: <b>฿${Math.floor(shop).toLocaleString()}</b></div>
                </div>
            </div>
            <div style="font-weight:600; font-size:0.9rem; margin-bottom:10px; color:var(--sub);"><i class="fas fa-history"></i> รายการละเอียดย้อนหลัง</div>
        `;

        container.innerHTML = summaryHTML;
        renderDataView(targetDate, 'hist-page-container', null, null, null, null, null, null, null, null, null, null, true);
    }

    function renderDataView(date, containerId, totalId, countId, transId, barberId, shopId, washId, shaveId, colorId, statusId, dateDisplayId, isAppend = false) {
        const data = db.filter(r => r.date === date);
        let sumTotal = 0, sumTrans = 0, sumCash = 0, cWash = 0, cShave = 0, cColor = 0;
        const container = document.getElementById(containerId);
        let listHTML = '';

        if(dateDisplayId) document.getElementById(dateDisplayId).innerText = formatDateBE(date);

        data.forEach((r) => {
            sumTotal += r.total;
            const isTrans = r.pay === 'โอนเงิน';
            const payColor = isTrans ? '#2b459a' : '#f59e0b';
            const payBg = isTrans ? '#eef2ff' : '#fff7ed';
            if(isTrans) sumTrans += r.total; else sumCash += r.total;
            
            r.items.forEach(it => {
                if(it.svc === 'โกนหนวด') cShave++;
                if(it.svc === 'สระผม') cWash++;
                if(it.svc === 'ย้อมผม') cColor++;
            });

            listHTML += `
                <div class="hist-card" style="border-left: 5px solid ${payColor};">
                    <div style="flex: 1;">
                        <div style="font-weight:600; color: var(--text);">
                            ${r.items.map(i=> (i.svc || '') + (i.style ? ' '+i.style : '')).join(' + ')}
                        </div>
                        <div style="font-size:0.75rem; color:var(--sub);"><i class="far fa-clock"></i> ${r.time}</div>
                    </div>
                    <div style="text-align:right; display:flex; align-items:center;">
                        <div style="margin-right:12px;">
                            <div style="font-weight:700; color:${payColor};">฿${r.total.toLocaleString()}</div>
                            <div style="font-size:0.6rem; padding:1px 6px; border-radius:50px; background:${payBg}; color:${payColor}; border:1px solid ${payColor}33;">${r.pay}</div>
                        </div>
                        <i class="fas fa-trash-alt hist-del" onclick="delItem(${r.id}, '${date}')"></i>
                    </div>
                </div>`;
        });

        if (data.length === 0) listHTML = '<div style="text-align:center; color:#ccc; padding:20px;">ไม่มีข้อมูล</div>';

        if(isAppend) container.innerHTML += listHTML; else container.innerHTML = listHTML;

        // คำนวณเงินประกัน
        let barber = cfg.mode === 'percent' ? Math.max(cfg.guarantee, (sumTotal * cfg.percent / 100)) : cfg.guarantee;
        let shop = sumTotal - barber;
        let settle = sumCash - barber;

        if(totalId) document.getElementById(totalId).innerText = sumTotal.toLocaleString();
        if(countId) document.getElementById(countId).innerText = data.length;
        if(transId) document.getElementById(transId).innerText = sumTrans.toLocaleString();
        if(barberId) document.getElementById(barberId).innerText = Math.floor(barber).toLocaleString();
        if(shopId) document.getElementById(shopId).innerText = Math.floor(shop).toLocaleString();
        if(washId) document.getElementById(washId).innerText = cWash;
        if(shaveId) document.getElementById(shaveId).innerText = cShave;
        if(colorId) document.getElementById(colorId).innerText = cColor;

        if(statusId) {
            const bar = document.getElementById(statusId);
            if(sumTotal === 0) { 
                bar.innerText = `ประกันรายได้วันนี้ ฿${cfg.guarantee.toLocaleString()}`; 
                bar.className = "status-bar blue"; 
            } else {
                if(settle > 0) { bar.innerText = `ช่างคืนร้าน ฿${settle.toLocaleString()}`; bar.className = 'status-bar orange'; }
                else if (settle < 0) { bar.innerText = `ร้านคืนช่าง ฿${Math.abs(settle).toLocaleString()}`; bar.className = 'status-bar blue'; }
                else { bar.innerText = 'ยอดพอดีไม่ต้องเคลียร์'; bar.className = 'status-bar green'; }
            }
        }
    }

    function delItem(id, date) {
        if(confirm('ลบรายการนี้?')) {
            db = db.filter(r => r.id !== id);
            localStorage.setItem('barber_v6_db', JSON.stringify(db));
            renderReport(); renderHistoryPage();
        }
    }

    function clearData() {
        if(confirm('ล้างข้อมูลทั้งหมดของวันนี้?')) {
            const today = document.getElementById('rec-date-raw').value;
            db = db.filter(r => r.date !== today);
            localStorage.setItem('barber_v6_db', JSON.stringify(db));
            renderReport();
        }
    }
function renderMonthlySummary() {
    const selectedDate = document.getElementById('hist-date-select').value;
    if (!selectedDate) return alert("กรุณาเลือกวันที่ในเดือนที่ต้องการ");

    const [year, month] = selectedDate.split('-');
    const monthYearPrefix = `${year}-${month}`; // เช่น "2023-10"

    // กรองข้อมูลเฉพาะเดือนที่เลือก
    const monthlyData = db.filter(r => r.date.startsWith(monthYearPrefix));
    const container = document.getElementById('hist-page-container');

    if (monthlyData.length === 0) {
        container.innerHTML = '<div style="text-align:center; color:#ccc; padding:20px;">ไม่มีข้อมูลของเดือนนี้</div>';
        return;
    }

    let totalSales = 0;
    let totalBarber = 0;
    let totalShop = 0;
    let svcCount = {};
    let dailyStats = new Set(); // เก็บวันที่ที่มีงานเพื่อหาค่าเฉลี่ย

    // วนลูปคำนวณทั้งเดือน
    // เราต้องคำนวณ "ประกันรายได้" แยกเป็นรายวันแล้วค่อยเอามาบวกกัน (เพราะประกันจ่ายเป็นวัน)
    const datesInMonth = [...new Set(monthlyData.map(r => r.date))];
    
    datesInMonth.forEach(d => {
        const dayRecords = monthlyData.filter(r => r.date === d);
        let dayTotal = dayRecords.reduce((sum, r) => sum + r.total, 0);
        
        // คำนวณรายได้ช่างของวันนั้น (ตามกฎประกัน)
        let dayBarber = cfg.mode === 'percent' 
            ? Math.max(cfg.guarantee, (dayTotal * cfg.percent / 100)) 
            : cfg.guarantee;
        
        if(dayTotal === 0) dayBarber = 0;
        
        totalSales += dayTotal;
        totalBarber += dayBarber;
        totalShop += (dayTotal - dayBarber);
        dailyStats.add(d);

        // นับบริการ
        dayRecords.forEach(r => {
            r.items.forEach(it => {
                if(it.svc) svcCount[it.svc] = (svcCount[it.svc] || 0) + 1;
            });
        });
    });

    const avgCustomers = (monthlyData.length / dailyStats.size).toFixed(1);

    // แสดงผลหน้าสรุปรายเดือน
    container.innerHTML = `
        <div class="card" style="background: linear-gradient(135deg, #1e293b, #334155); color: white; border: none; padding: 20px;">
            <div style="text-align:center; margin-bottom:15px;">
                <div class="label" style="color:rgba(255,255,255,0.6);">สรุปภาพรวมรายเดือน</div>
                <div style="font-size:1.2rem; font-weight:600;">ประจำเดือน ${month}/${parseInt(year)+543}</div>
            </div>
            
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px; margin-bottom:20px;">
                <div style="background:rgba(255,255,255,0.1); padding:10px; border-radius:12px; text-align:center;">
                    <div class="label" style="color:rgba(255,255,255,0.6);">รายรับทั้งหมด</div>
                    <div style="font-size:1.4rem; font-weight:700;">฿${totalSales.toLocaleString()}</div>
                </div>
                <div style="background:rgba(255,255,255,0.1); padding:10px; border-radius:12px; text-align:center;">
                    <div class="label" style="color:rgba(255,255,255,0.6);">ลูกค้าสะสม</div>
                    <div style="font-size:1.4rem; font-weight:700;">${monthlyData.length} คน</div>
                </div>
            </div>

            <div style="border-top:1px dashed rgba(255,255,255,0.2); padding-top:15px; margin-bottom:15px;">
                <div style="display:flex; justify-content:space-between; margin-bottom:8px;">
                    <span>ยอดจ่ายช่างรวม:</span>
                    <b style="color:#fbbf24;">฿${Math.floor(totalBarber).toLocaleString()}</b>
                </div>
                <div style="display:flex; justify-content:space-between;">
                    <span>กำไรร้านรวม:</span>
                    <b style="color:#34d399;">฿${Math.floor(totalShop).toLocaleString()}</b>
                </div>
            </div>

            <div style="font-size:0.8rem; background:rgba(0,0,0,0.2); padding:10px; border-radius:8px;">
                <b>สถิติบริการ:</b><br>
                ${Object.entries(svcCount).map(([name, count]) => `${name}: ${count}`).join(' | ')}
                <div style="margin-top:5px; border-top:1px solid rgba(255,255,255,0.1); pt:5px;">
                    เฉลี่ยลูกค้า ${avgCustomers} คน/วัน (นับเฉพาะวันที่มาทำงาน)
                </div>
            </div>
        </div>
        <button onclick="renderHistoryPage()" style="width:100%; background:none; border:1px solid var(--sub); color:var(--sub); padding:10px; border-radius:10px; margin-top:10px;">
            กลับไปดูแบบรายวัน
        </button>
    `;
}
   </script>
